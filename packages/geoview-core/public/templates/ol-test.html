<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@master/en/v6.14.1/css/ol.css"
      type="text/css"
    />
    <style>
      .map {
        height: 800px;
width: 2000px;
      }
    </style>
    <script src="https://cdn.jsdelivr.net/gh/openlayers/openlayers.github.io@master/en/v6.14.1/build/ol.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.6.2/proj4.js"></script>
    <title>OpenLayers example</title>
  </head>
  <body>
    <h2>My Map</h2>
    <div id="map" class="map"></div>
    <div id="mouse-position"></div>
    <script type="text/javascript">

      // var map = new ol.Map({
      //         target: 'map',
      //         layers: [
      //           new ol.layer.Tile({
      //             source: new ol.source.OSM()
      //           })
      //         ],
      //         view: new ol.View({
      //           center: ol.proj.fromLonLat([37.41, 8.82]),
      //           zoom: 4
      //         })
      //       });

      // import TileLayer from "ol/layer/Tile";
      // import TileGrid from "ol/tilegrid/TileGrid";
      // import View from "ol/View";
      // import XYZ from "ol/source/XYZ";
      // import { fromLonLat } from "ol/proj";
      // import proj4 from "proj4";
      // import { register } from "ol/proj/proj4";

      proj4.defs(
        "EPSG:3978",
        "+proj=lcc +lat_1=49 +lat_2=77 +lat_0=49 +lon_0=-95 +x_0=0 +y_0=0 +ellps=GRS80 +towgs84=0,0,0,0,0,0,0 +units=m +no_defs"
      );
      ol.proj.proj4.register(proj4);

      const resolutionsLCC = [
        38364.660062653464,
        22489.62831258996,
        13229.193125052918,
        7937.5158750317505,
        4630.2175937685215,
        2645.8386250105837,
        1587.5031750063501,
        926.0435187537042,
        529.1677250021168,
        317.50063500127004,
        185.20870375074085,
        111.12522225044451,
        66.1459656252646,
        38.36466006265346,
        22.48962831258996,
        13.229193125052918,
        7.9375158750317505,
        4.6302175937685215
      ];

      const resol2 = [1.37016643080888E8,
      8.032010111638261E7,
      4.724711830375448E7,
      2.8348270982252687E7,
      1.653649140631407E7,
      9449423.660750896,
      5669654.196450537,
      3307298.2812628136,
      1889884.7321501793,
      1133930.8392901076,
      661459.6562525628,
      396875.7937515376,
      236235.59151877242,
      137016.643080888,
      80320.10111638262,
      47247.118303754476,
      28348.27098225269,
      16536.491406314068,
      9449.423660750896,
      5669.654196450538,];

      const projectionLCC = "EPSG:3978";
      const projectionWM = "EPSG:3857";

      const urlLCC =
        "https://maps-cartes.services.geo.ca/server2_serveur2/rest/services/BaseMaps/CBMT_CBCT_GEOM_3978/MapServer/WMTS/tile/1.0.0/CBMT_CBCT_GEOM_3978/default/default028mm/{z}/{y}/{x}";
      const urlLCCText =
        "https://maps-cartes.services.geo.ca/server2_serveur2/rest/services/BaseMaps/CBMT_TXT_3978/MapServer/WMTS/tile/1.0.0/CBMT_TXT_3978/default/default028mm/{z}/{y}/{x}";
      const urlLCCShade =
        "https://maps-cartes.services.geo.ca/server2_serveur2/rest/services/BaseMaps/CBME_CBCE_HS_RO_3978/MapServer/WMTS/tile/1.0.0/CBMT_CBCT_GEOM_3978/default/default028mm/{z}/{y}/{x}";
      const urlWM =
        "https://maps-cartes.services.geo.ca/server2_serveur2/rest/services/BaseMaps/CBMT_CBCT_GEOM_3857/MapServer/WMTS/tile/1.0.0/BaseMaps_CBMT_CBCT_GEOM_3857/default/default028mm/{z}/{y}/{x}";
      const urlWMText =
        "https://maps-cartes.services.geo.ca/server2_serveur2/rest/services/BaseMaps/CBMT_TXT_3857/MapServer/WMTS/tile/1.0.0/CBMT_TXT_3857/default/default028mm/{z}/{y}/{x}";

      //const extentLCC2 = [-4084977.591304394, -1271987.4851627997, 4122413.823478435, 4141398.3416088535];
      const extentLCC2 = [-4926564.35035694, -5396818.737236813, 5347435.64964306, 4623181.262763187];

      const WM = new ol.layer.Tile({
        source: new ol.source.XYZ({
          projection: projectionWM,
          url: urlWM
        })
      });
      const WMText = new ol.layer.Tile({
        source: new ol.source.XYZ({
          projection: projectionWM,
          url: urlWMText
        })
      });

      const LCC = new ol.layer.Tile({
        preload: 17,
        minZoom: 0,
        maxZoom: 17,
        opacity: 0.7,
        source: new ol.source.XYZ({
          attributions: ['my attrib'],
          projection: projectionLCC,
          url: urlLCC,
          wrapX: false,
          tileGrid: new ol.tilegrid.TileGrid({
            extent: extentLCC2, //[-4084977.591304394, -1271987.4851627997, 4122413.823478435, 4141398.3416088535],
            origin: [-3.46558e7, 3.931e7],
            resolutions: resolutionsLCC,
            minZoom: 0,
          })
        })
      });
      const LCCShade = new ol.layer.Tile({
        preload: 17,
        minZoom: 0,
        maxZoom: 12,
        source: new ol.source.XYZ({
          projection: projectionLCC,
          url: urlLCCShade,
          wrapX: false,
          tileGrid: new ol.tilegrid.TileGrid({
            extent: [-2750565.143300003, -936638.5000000009, 3583872.5000000005, 4659267],
            origin: [-3.46558e7, 3.931e7],
            resolutions: resolutionsLCC,
            minZoom: 0,
          })
        })
      });
      const LCCText = new ol.layer.Tile({
        preload: 17,
        opacity: 0.85,
        minZoom: 0,
        maxZoom: 17,
        source: new ol.source.XYZ({
          projection: projectionLCC,
          url: urlLCCText,
          wrapX: false,
          tileGrid: new ol.tilegrid.TileGrid({
            extent: [-4084977.591304394, -1271987.4851627997, 4122413.823478435, 4141398.3416088535],
            origin: [-3.46558e7, 3.931e7],
            resolutions: resolutionsLCC,
            minZoom: 0,
          })
        })
      });

      const scaleControl = new ol.control.ScaleLine({
        units: 'metric',
        bar: true,
        steps: 4,
        text: true,
        minWidth: 140,
      });

      const attribution = new ol.control.Attribution({
        collapsible: true,
      });

      const mousePosition = new ol.control.MousePosition({
        coordinateFormat: ol.coordinate.createStringXY(4),
        projection: 'EPSG:4326',
        // comment the following two lines to have the mouse position
        // be placed within the map.
        className: 'custom-mouse-position',
        target: document.getElementById('mouse-position'),
      });

      console.log(ol.proj.fromLonLat([-80, 30], 'EPSG:3978'))
      console.log(ol.proj.fromLonLat([-80, 30], 'EPSG:4326', 'EPSG:3978'))
      console.log(ol.proj.transform([-80, 30], 'EPSG:4326', 'EPSG:3978'))

      const map = new ol.Map({
        target: "map",
        renderer: 'dom',
        layers: [LCCShade, LCC, LCCText],
        // TODO replicate view object to schema
        view: new ol.View({
          controls: ol.control.defaults().extend([scaleControl]),
          projection: 'EPSG:3978',
          center: ol.proj.fromLonLat([-100, 55], 'EPSG:3978'),
          extent: [-4084977.591304394, -1271987.4851627997, 4122413.823478435, 4141398.3416088535],
          zoom: 3,
          minZoom: 2,
          maxZoom: 17,
        })
      });

      map.addControl(scaleControl);
      map.addControl(attribution);
      map.addControl(mousePosition)

      let timerStart = Date.now();
      map.on('movestart', (evt) => {
        console.log('pre');
        timerStart = Date.now();
      });
      map.on('rendercomplete', (evt) => {
        console.log("Time until everything loaded: ", Date.now()-timerStart);
      });
    </script>
  </body>
</html>

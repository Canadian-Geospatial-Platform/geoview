<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title><%= htmlWebpackPlugin.options.title %></title>
    <link rel="shortcut icon" href="./favicon.ico" />
    <meta name="msapplication-TileColor" content="#da532c" />
    <meta name="msapplication-config" content="./img/browserconfig.xml" />
    <meta name="theme-color" content="#ffffff" />
    <meta name="msapplication-TileColor" content="#da532c" />
    <meta name="theme-color" content="#ffffff" />
    <link href="https://fonts.googleapis.com/css?family=Roboto|Montserrat:200,300,400,900|Merriweather" rel="stylesheet" type="text/css" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons" />
    <link rel="stylesheet" href="css/style.css" />

    <style>
      .editor {
        display: inline-flex;
        gap: 10px;
        font-family: monospace;
        line-height: 21px;
        background: #282a3a;
        border-radius: 2px;
        padding: 20px 10px;
        height: 500px;
        overflow-y: auto;
      }

      .line-numbers {
        width: 20px;
        text-align: right;
        height: 9999px;
      }

      .line-numbers span {
        counter-increment: linenumber;
      }

      .line-numbers span::before {
        content: counter(linenumber);
        display: block;
        color: #506882;
      }

      textarea {
        height: 9999px;
        line-height: 21px;
        overflow-y: hidden;
        padding: 0;
        border: 0;
        background: #282a3a;
        color: #fff;
        min-width: 500px;
        outline: none;
        resize: none;
      }
    </style>
  </head>

  <body>
    <div class="header-table">
      <table>
        <tbody>
          <tr>
            <td><img class="header-logo" alt="logo" src="./img/Logo.png" /></td>
            <td class="header-title">
              <h1><strong>Sandbox Configuration</strong></h1>
            </td>
          </tr>
        </tbody>
      </table>
      <table>
        <tbody>
          <tr>
            <td><a href="./index.html">Main</a><br /></td>
          </tr>
        </tbody>
      </table>
      <table>
        <tbody>
          <tr>
            <td>This page is used to test map configuration.</td>
          </tr>
        </tbody>
      </table>
      <table>
        <tbody>
          <tr>
            <td>
              <div class="editor">
                <div class="line-numbers" id="inputLineNumbers">
                  <span></span>
                </div>
                <textarea id="configGeoview" name="configuration" cols="110">
{
  'map': {
    'interaction': 'dynamic',
    'viewSettings': {
      'projection': 3978
    },
    'basemapOptions': {
      'basemapId': 'transport',
      'shaded': false,
      'labeled': true
    },
    'listOfGeoviewLayerConfig': [
      {
      'geoviewLayerId': 'wmsLYR1',
      'geoviewLayerName': {
        'en': 'Earthquakes',
        'fr': 'Tremblements de terre'
      },
      'accessPath': {
        'en': 'https://maps-cartes.services.geo.ca/server_serveur/rest/services/NRCan/earthquakes_en/MapServer/',
        'fr': 'https://maps-cartes.services.geo.ca/server_serveur/rest/services/NRCan/earthquakes_fr/MapServer/'
      },
      'geoviewLayerType': 'esriFeature',
      'listOfLayerEntryConfig': [
        {
          'id': '0',
          'geometryType': 'point',
          'name': {
            'en': 'Earthquakes 1980-1990',
            'fr': ' Tremblements de terre 1980-1990'
          },
          'initialSettings': {
            'controls': {
              'query': true
            },
            'states': {
              'queryable': true
            }
          },
          'attributtions': 'Ressources naturelles Canada, Secteur des terres et des minéraux, Commission Géologique du Canada, Service canadien d\'information sur les risques',
          'source': {
            'layerFilter': '',
            'maxRecordCount': 0,
            'featureInfo': {
              'nameField': 'date',
              'outfields': [
                {
                  'name': 'magnitude_codelist',
                  'alias': 'magnitude_codelist',
                  'type': 'date',
                  'domain': []
                },
                {
                  'name': 'magnitude',
                  'alias': 'Magnitude',
                  'type': 'number',
                  'domain': []
                },
                {
                  'name': 'magnitude_type',
                  'alias': 'Magnitude Type',
                  'type': 'string',
                  'domain': []
                },
                {
                  'name': 'date',
                  'alias': 'Date',
                  'type': 'string',
                  'domain': []
                },
                {
                  'name': 'place',
                  'alias': 'Place',
                  'type': 'string',
                  'domain': []
                },
                {
                  'name': 'depth',
                  'alias': 'Depth',
                  'type': 'number',
                  'domain': []
                },
                {
                  'name': 'latitude',
                  'alias': 'Latitude',
                  'type': 'number',
                  'domain': []
                },
                {
                  'name': 'longitude',
                  'alias': 'Longitude',
                  'type': 'number',
                  'domain': []
                },
                {
                  'name': 'OBJECTID',
                  'alias': 'OBJECTID',
                  'type': 'number',
                  'domain': []
                }
              ]
            }
          }
        },
        {
          'id': '1',
          'name': {
            'en': 'Earthquakes 1990-2000',
            'fr': ' Tremblements de terre 1990-2000'
          },
          'attributtions': 'Ressources naturelles Canada, Secteur des terres et des minéraux, Commission Géologique du Canada, Service canadien d\'information sur les risques',
          'source': {
            'layerFilter': '',
            'maxRecordCount': 0,
            'featureInfo': {
              'nameField': 'date',
              'outfields': [
                {
                  'name': 'magnitude_codelist',
                  'alias': 'magnitude_codelist',
                  'type': 'date',
                  'domain': []
                },
                {
                  'name': 'magnitude',
                  'alias': 'Magnitude',
                  'type': 'number',
                  'domain': []
                },
                {
                  'name': 'magnitude_type',
                  'alias': 'Magnitude Type',
                  'type': 'string',
                  'domain': []
                },
                {
                  'name': 'date',
                  'alias': 'Date',
                  'type': 'string',
                  'domain': []
                },
                {
                  'name': 'place',
                  'alias': 'Place',
                  'type': 'string',
                  'domain': []
                },
                {
                  'name': 'depth',
                  'alias': 'Depth',
                  'type': 'number',
                  'domain': []
                },
                {
                  'name': 'latitude',
                  'alias': 'Latitude',
                  'type': 'number',
                  'domain': []
                },
                {
                  'name': 'longitude',
                  'alias': 'Longitude',
                  'type': 'number',
                  'domain': []
                },
                {
                  'name': 'OBJECTID',
                  'alias': 'OBJECTID',
                  'type': 'number',
                  'domain': []
                }
              ]
            }
          }
        }
      ]
    }]
  },
  'components': ['overview-map'],
  'footerBar': {
    'tabs': {
      'core': ['legend', 'layers', 'details', 'data-table']
    }
  },
  'corePackages': [],
  'theme': 'geo.ca',
  'suportedLanguages': ['en']
}
                </textarea>
              </div>
            </td>
            <td>
              <span id="validationMessage" style="margin:10px;">File not validated...</span>
              <div class="editor">
                <div class="line-numbers" id="outputLineNumbers">
                  <span></span>
                </div>
                <textarea id="configOutput" name="configuration" cols="110">
                </textarea>
              </div>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
    <div>
      <button id="validateConfig" style="margin:10px;">Validate</button>
      <select id="language">
        <option value="en">English</option>
        <option value="fr">Français</option>
      </select>
      <button id="createMap" style="margin:10px;">Create Map</button>
      <button id="deleteMap" style="margin:10px;">Delete map</button>
      <br />
    </div>
    <div class="editor" style="height:60px">
      <div class="line-numbers" id="inputLineNumbers">
        <span></span>
      </div>
      <div>
        <textarea id="configUrlGeoview" name="Urlconfiguration" cols="210">
p=3857&z=4&c=-100,40&l=en&t=dark&b=basemapId:transport,shaded:false,labeled:true&i=dynamic&cc=overview-map&keys=12acd145-626a-49eb-b850-0a59c9bc7506,ccc75c12-5acc-4a6a-959f-ef6f621147b9
        </textarea>
      </div>
    </div>
    <div>
      <button id="validateUrlConfig" style="margin:10px;">Validate</button>
      <select id="urlLanguage">
        <option value="en">English</option>
        <option value="fr">Français</option>
      </select>
      <br />
    </div>
    <div class="map-title-holder">
      <h4 id="HLCONF1">Sanbox Map</h4>
      <a class="ref-link" href="#top">Top</a>
    </div>
    <div id="mapSection">
      <div id="sandboxMap"></div>
    </div>
    <p>This map loads it's configurations from the text area.</p>
    <hr />

    <button type="button" class="collapsible">Code Snippet</button>
    <pre id="codeSnippet" class="panel"></pre>

    <script src="codedoc.js"></script>

    <script>
      // Config Validate Button============================================================================================================
      const validateJSONButton = document.getElementById('validateConfig');

      // add an event listener when a button is clicked
      validateJSONButton.addEventListener('click', function (e) {
        // get message element
        const message = document.getElementById('validationMessage');
        const langue = document.getElementById('language').value;
        const configArea = document.getElementById('configGeoview');
        const configOutput = document.getElementById('configOutput');

        // get config and test if JSON is valid
        const mapConfig = cgpv.api.configApi.getMapConfig(configArea.value, langue);
        configOutput.value = mapConfig.getIndentedJsonString();

        // Generate line numbers
        (() => {
          const textarea = document.getElementById('configOutput');
          const lineNumbersContainer = document.getElementById('outputLineNumbers');
          const lines = textarea.value.split('\n').length;
          const lineNumbers = Array.from({ length: lines }, (_, index) => '').join('<span />');
          lineNumbersContainer.innerHTML = lineNumbers;
        })();

        // set class and message
        message.classList.add('config-json-valid');
        message.classList.remove('config-error');
        if (mapConfig.isValid) {
          message.innerHTML = 'File is valid, see console for details...';
          document.getElementById('createMap').disabled = true;
        } else {
          message.innerHTML = 'File is invalid, see console for details...';
        }
      });

      // Config Url Validate Button========================================================================================================
      const validateURLButton = document.getElementById('validateUrlConfig');

      // add an event listener when the button is clicked
      validateURLButton.addEventListener('click', function (e) {
        // get message element
        const message = document.getElementById('validationMessage');
        const langue = document.getElementById('urlLanguage').value;
        const configArea = document.getElementById('configGeoview');
        const configUrlArea = document.getElementById('configUrlGeoview');
        const configOutput = document.getElementById('configOutput');

        configArea.value = configUrlArea.value;
        // get config and test if URL Config is valid
        const returnedValue = cgpv.api.configApi.getConfigFromUrl(configUrlArea.value);
        returnedValue.then((mapConfig) => {
          configOutput.value = mapConfig.getIndentedJsonString();

          // Generate line numbers
          (() => {
            const textarea = document.getElementById('configOutput');
            const lineNumbersContainer = document.getElementById('outputLineNumbers');
            const lines = textarea.value.split('\n').length;
            const lineNumbers = Array.from({ length: lines }, (_, index) => '').join('<span />');
            lineNumbersContainer.innerHTML = lineNumbers;
          })();

          // set class and message
          message.classList.add('config-json-valid');
          message.classList.remove('config-error');
          if (mapConfig.isValid) {
            message.innerHTML = 'File is valid, see console for details...';
            document.getElementById('createMap').disabled = true;
          } else {
            message.innerHTML = 'File is invalid, see console for details...';
          }
        });
      });

      // Create Button============================================================================================================
      const createMapButton = document.getElementById('createMap');
      createMapButton.disabled = true;

      // add an event listener when a button is clicked
      createMapButton.addEventListener('click', function (e) {
        // delete old map
        cgpv.api.maps['sandboxMap']?.remove(true);

        // create new map in a new dom node
        const newDiv = document.createElement('div');
        const a = document.createAttribute("id");
        a.value = "sandboxMap";
        newDiv.setAttributeNode(a);
        document.getElementById('mapSection').appendChild(newDiv);

        // create map
        cgpv.api.createMapFromConfig('sandboxMap', document.getElementById('configOutput').value);
      });

      const deleteMapButton = document.getElementById('deleteMap');
      deleteMapButton.disabled = true;

      // add an event listener when a button is clicked
      deleteMapButton.addEventListener('click', function (e) {
        // Delete the map
        cgpv.api.maps['sandboxMap'].remove(true);
      });

      // Editor script section===================================================================================================
      const textarea = document.querySelector('textarea');
      const lineNumbers = document.querySelector('.line-numbers');

      // set default number of lines
      const numberOfLines = textarea.value.split('\n').length;
      lineNumbers.innerHTML = Array(numberOfLines).fill('<span></span>').join('');

      textarea.addEventListener('keyup', (event) => {
        const numberOfLines = event.target.value.split('\n').length;
        lineNumbers.innerHTML = Array(numberOfLines).fill('<span></span>').join('');
      });

      textarea.addEventListener('input', (event) => {
        document.getElementById('createMap').disabled = true;
      });

      // create snippets
      window.addEventListener('load', () => {
        createCodeSnippet();
        createConfigSnippet();
      });
    </script>
  </body>
</html>

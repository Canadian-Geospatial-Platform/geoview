<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Important Layers Test Panel - Canadian Geospatial Platform Viewer</title>
    <link rel="shortcut icon" href="./favicon.ico" />
    <meta name="msapplication-TileColor" content="#da532c" />
    <meta name="msapplication-config" content="./img/browserconfig.xml" />
    <meta name="theme-color" content="#ffffff" />
    <meta name="msapplication-TileColor" content="#da532c" />
    <meta name="theme-color" content="#ffffff" />
    <link rel="stylesheet" href="css/style.css" />
  </head>

  <body>
    <div id="page-header"></div>
    <div>      <div class="back-to-main back-to-main-flex">
        <a href="./index.html?tab=testing" class="btn btn-primary">‚Üê Back to Main</a>
      </div>

      <div class="demo-section">
        <h4>Test Important Layers</h4>
      </div>
    </div>


      <div class="navigator-option-group">
        <label for="projections" class="navigator-label">Projection:</label>
        <select name="projections" id="projections" class="navigator-select">
          <option value="3857">Web Mercator (3857)</option>
          <option value="3978">LCC (3978)</option>
        </select>
        <button type="button" class="btn btn-primary" onclick="reloadMap()">Set Projection</button>
      </div>
    </div>

    <button class="collapsible">Layers Status</button>
    <pre id="mapWM-state" class="panel map-title-holder"></pre>

    <div
      id="map1"
      class="geoview-map"
      data-lang="en"
      data-config="{
        'map': {
          'interaction': 'dynamic',
          'viewSettings': {
            'projection': 3857
          },
          'basemapOptions': {
            'basemapId': 'transport',
            'shaded': true,
            'labeled': true
          },
          'listOfGeoviewLayerConfig': []
        },
        'theme': 'geo.ca',
        'components': [],
        'footerBar': {
          'tabs': {
            'core': ['legend', 'layers', 'details', 'data-table', 'geochart', 'time-slider']
          }
        },
        'corePackages': [],
        'externalPackages': [],
        'appBar': {
          'tabs': {
            'core': []
          }
        }
      }"
    ></div>
    
    <div class="demo-section">
      <h4 id="HUC1">Drop-down Selectors</h4>
      <div class="navigator-selector-wrap">
        <div class="demo-important-selector">
          <label class="navigator-label">Group Selector</label>
          <select id="selectGroup" class="navigator-select">
            <option value="dataTeam">Data Team</option>
            <option value="OSDP">OSDP</option>
          </select>
        </div>
        <div class="demo-important-selector">
          <label class="navigator-label">Sub Group Selector</label>
          <select id="selectSubGroup" class="navigator-select"></select>
        </div>
        <div class="demo-important-selector">
          <label class="navigator-label">Service Selector</label>
          <select id="selectService" class="navigator-select"></select>
        </div>
        <div class="demo-important-selector">
          <label class="navigator-label">&nbsp;</label>
          <button type="button" class="btn btn-success" onclick="addLayer()">Add layer</button>
        </div>
      </div>
      <div>
        <table class="display-fields">
          <tr>
            <td class="display-fields">Type</td>
            <td class="display-fields" id="type-field"></td>
          </tr>
          <tr>
            <td class="display-fields">Access Path</td>
            <td class="display-fields" id="access-path-field"></td>
          </tr>
          <tr>
            <td class="display-fields">Layer Id</td>
            <td class="display-fields" id="layer-id-field"></td>
          </tr>
        </table>
      </div>
    </div>
    <hr />

    <script src="codedoc.js"></script>
    <script>
      insertPageHeader();

      async function addGeocore(uuid) {
        const geoviewConfig = await cgpv.api.layer.convertMapConfigToGeoviewLayerConfig('map1', 'en', {
          geoviewLayerType: 'geoCore',
          geoviewLayerId: uuid,
        });
        document.getElementById('type-field').innerText = geoviewConfig
          ? `geoCore converted to ${geoviewConfig.geoviewLayerType}`
          : 'geocore conversion error';
        document.getElementById('access-path-field').innerText = geoviewConfig ? geoviewConfig.metadataAccessPath : '';

        cgpv.api.getMapViewer('map1').layer.addGeoviewLayerByGeoCoreUUID(uuid);
      }

      async function addGeoviewLayer(geoviewLayerType, metadataAccessPath, layerId) {
        // adding a geojson layer requires a type of geojson and url
        const addResult = cgpv.api.getMapViewer('map1').layer.addGeoviewLayer(
          {
            geoviewLayerType: `${geoviewLayerType}`,
            metadataAccessPath: `${metadataAccessPath}`,
            listOfLayerEntryConfig: [
              {
                layerId: `${layerId}`,
              },
            ],
          },
          ['en', 'fr']
        );
      }

      async function addLayer() {
        const geoviewLayerType = document.getElementById('type-field').innerText;
        const metadataAccessPath = document.getElementById('access-path-field').innerText;
        const layerId = document.getElementById('layer-id-field').innerText;

        if (cgpv.api.config.isValidUUID(layerId)) addGeocore(layerId);
        else addGeoviewLayer(geoviewLayerType, metadataAccessPath, layerId);
      }

      function reloadMap() {
        cgpv.api.getMapViewer('map1').setProjection(Number(document.getElementById('projections').value));
      }

      async function addGeocoreNametoSelectOption(uuid, optionElement) {
        const geoviewConfig = await cgpv.api.layer.convertMapConfigToGeoviewLayerConfig('map1', 'en', {
          geoviewLayerType: 'geoCore',
          geoviewLayerId: uuid,
        });
        optionElement.innerText = geoviewConfig ? geoviewConfig.geoviewLayerName : `WRONG - ${uuid}`;
      }

      function initServiceDropDown(groupHasChanged) {
        const groupDropDown = document.getElementById('selectGroup');
        const subGroupDropDown = document.getElementById('selectSubGroup');
        if (groupHasChanged) {
          subGroupDropDown.innerHTML = '';
          Object.keys(importantLayersData[groupDropDown.value]).forEach((element) => {
            const optionElement = document.createElement('option');
            optionElement.value = element;
            optionElement.innerText = element;
            subGroupDropDown.appendChild(optionElement);
          });
        }

        const serviceDropDown = document.getElementById('selectService');
        serviceDropDown.innerHTML = '';
        importantLayersData[groupDropDown.value][subGroupDropDown.value].forEach((element, i) => {
          const optionElement = document.createElement('option');
          optionElement.value = `${i}`;
          optionElement.innerText =
            element.type === 'geoCore' && element.optionDisplayValue === ''
              ? addGeocoreNametoSelectOption(element.layerId, optionElement)
              : element.optionDisplayValue;
          serviceDropDown.appendChild(optionElement);
        });
        initTableFields();
      }

      function initTableFields() {
        const groupDropDown = document.getElementById('selectGroup');
        const subGroupDropDown = document.getElementById('selectSubGroup');
        const serviceDropDown = document.getElementById('selectService');
        const serviceInfo = importantLayersData[groupDropDown.value][subGroupDropDown.value][serviceDropDown.value];
        document.getElementById('type-field').innerText = serviceInfo.type;
        document.getElementById('access-path-field').innerText = serviceInfo.accessPath;
        document.getElementById('layer-id-field').innerText = serviceInfo.layerId;
      }

      let importantLayersData;

      // Register handler when map has been initialized
      cgpv.onMapInit((mapViewer) => {
        // fetch JSON config file to show in the text are section
        function fetchJSONData() {
          fetch('./configs/important-layers.json')
            .then((res) => {
              if (!res.ok) {
                throw new Error(`HTTP error! Status: ${res.status}`);
              }
              return res.json();
            })
            .then((data) => {
              importantLayersData = data;
              initServiceDropDown(true);
            })
            .catch((error) => console.error('Unable to fetch data:', error));
        }
        fetchJSONData();
        document.getElementById('selectGroup').addEventListener('change', (e) => {
          initServiceDropDown(true);
        });
        document.getElementById('selectSubGroup').addEventListener('change', (e) => {
          initServiceDropDown(false);
        });
        document.getElementById('selectService').addEventListener('change', (e) => {
          initTableFields();
        });

        listenToLegendLayerSetChanges('mapWM-state', mapViewer);
      });

      // initialize cgpv
      cgpv.init();

      // create snippets
      window.addEventListener('load', () => {
        createCodeSnippet();
        createConfigSnippet();
      });
    </script>
  </body>
</html>

<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>OSDP Integration - Canadian Geospatial Platform Viewer</title>
    <link rel="shortcut icon" href="./favicon.ico" />
    <meta name="msapplication-TileColor" content="#da532c" />
    <meta name="msapplication-config" content="./img/browserconfig.xml" />
    <meta name="theme-color" content="#ffffff" />
    <meta name="msapplication-TileColor" content="#da532c" />
    <meta name="theme-color" content="#ffffff" />
    <link href="https://fonts.googleapis.com/css?family=Roboto|Montserrat:200,300,400,900|Merriweather" rel="stylesheet" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons" />
    <link rel="stylesheet" href="css/style.css" />
  </head>

  <body>
    <div class="header-table">
      <table>
        <tbody>
          <tr>
            <td><img class="header-logo" alt="logo" src="./img/Logo.png" /></td>
            <td class="header-title">
              <h1><strong>OSDP Integration</strong></h1>
            </td>
          </tr>
          <tr>
            <td><a href="./demos.html">Main</a><br /></td>
          </tr>
        </tbody>
      </table>
      <table>
        <tbody>
          <tr>
            <td><p>Demonstration of Open Science Data Portal Integration</p></td>
          </tr>
        </tbody>
      </table>
    </div>

    <div class="map-title-holder">
      <h4 id="HMap1">OSDP Integration</h4>
    </div>

    <div id="mapSection">
      <div id="Map1" class="geoview-map" data-lang="fr" data-config-url="./configs/OSDP/osdp-empty.json"></div>
    </div>

    <div>
      <ul>
        <li>
          <button id="deleteMap" style="margin: 10px">Delete map div</button>
          Deletes map div if it exists, leaving the map object in cgpv.maps - Simulates moving away from map tab.
          <details>
            <summary>Code</summary>
            <pre>
              document.getElementById('Map1').remove();
            </pre>
          </details>
        </li>
        <li>
          <button id="createMap" style="margin: 10px">Create map div</button>
          Creates a new div for the map, if the original div has been deleted
          <details>
            <summary>Code</summary>
            <pre>
              if (!document.getElementById('Map1')) {
                const newDiv = document.createElement('div');
                const id = document.createAttribute('id');
                id.value = 'Map1';
                newDiv.setAttributeNode(id);
                const dataLang = document.createAttribute('data-lang');
                dataLang.value = lang;
                newDiv.setAttributeNode(dataLang);
                document.getElementById('mapSection').appendChild(newDiv);
              }
            </pre>
          </details>
        </li>
        <li>
          <button id="refreshMap" style="margin: 10px">Refresh map</button>
          Recreates the map using the stored config, creating a new div if it has been deleted
          <details>
            <summary>Code</summary>
            <pre>
              <pre>
                return new Promise (resolve => {
                  removeMap('Map1')
                    .then(() => {
                      cgpv.api.createMapFromConfig('Map1', JSON.stringify(mapConfig), 800)
                      .then(() => {
                          resolve();
                        });
                    });
                  });

                  function removeMap(map) {
                    return new Promise(resolve => {
                      if (cgpv.api.maps[map]) {
                        cgpv.api.maps[map].remove(false)
                          .then(() => {
                            resolve();
                          });
                      } else {
                        resolve();
                      }
                    });
                  }
              </pre>
            </pre>
          </details>
        </li>
        <li>
          <button id="updateState" style="margin: 10px">Update State</button>
          Updates the stored config with the current map state
          <details>
            <summary>Code</summary>
            <pre>
              mapConfig = cgpv.api.maps.Map1.createMapConfigFromMapState();
            </pre>
          </details>
        </li>
        <li>
          <button id="changeLanguage" style="margin: 10px">Change Language</button>
          Changes the language from french to english or english to french and reloads the map if it exists. Note: this will change the
          names of the layers, as maintainGeocoreLayerNames is set to false. In this case, we will lose any custom names, and they will 
          have to be reinserted (in the new language). If set to true, the layer names will remain as they were.
          <details>
            <summary>Code</summary>
            <pre>
              lang = lang === 'fr' ? 'en' : 'fr';
              const mapDiv = document.getElementById('Map1');
              if (mapDiv) {
                mapDiv.setAttribute('data-lang', lang);
                cgpv.api.maps.Map1.reloadWithCurrentState(false);
              }
            </pre>
          </details>
        </li>
      </ul>
    </div>

    <ul>
      <li>
        <textarea id="layerUuids" cols="40" rows="5">21b821cf-0f1c-40ee-8925-eab12d357668,ccc75c12-5acc-4a6a-959f-ef6f621147b9,0fca08b5-e9d0-414b-a3c4-092ff9c5e326</textarea>
        <br>
        <button id="addLayers" style="margin: 10px">Add Layers</button>
        Add entered Geocore UUID's to the map. Can be separated with commas or each on a new line
        <details>
          <summary>Code</summary>
          <pre>
            if (document.getElementById('Map1')) {
              const layerUuids = document.getElementById('layerUuids').value;
              const uuidList = layerUuids.split('\n').join(',').split(',');
              addLayers(uuidList);
            }

            function addLayers(layers) {
              layers.forEach((layer) => {
                cgpv.api.maps.Map1.layer.addGeoviewLayerByGeoCoreUUID(layer);
              });
            }
          </pre>
        </details>
      </li>
      <li>
        <textarea id="layerNames" cols="100" rows="4">[Radioactivité de l'air, Radioactivity], [Périmètre de localisation des stations, Perimeter], [Carte commémorative du Canada, Commemorative Map]</textarea>
        <br>
        <button id="changeNames" style="margin: 10px">Change Names</button>
        Updates the current map config, replacing some of the default layer names (from above) and refreshes the map.
        Note: if the currently stored map config does not contain the default layers, the map will refresh with nothing changed.
        To execute properly - Add Layers, Update State, Change Names - Update Names and Change Names again will change them back.
        <details>
          <summary>Code</summary>
          <pre>
            const pairs = [["Radioactivité de l'air", 'Radioactivity'], ['Périmètre de localisation des stations', 'Perimeter'], ['Carte commémorative du Canada', 'Commemorative Map']];
            cgpv.api.maps.Map1.replaceMapConfigLayerNames(pairs, mapConfig);
            refreshMap();
          </pre>
        </details>
      </li>
    </ul>

    <div class="selector">
      <select name="Selecty custom config" id="switchCustom">
        <option value="Airborne Radioactivity">Airborne Radioactivity</option>
        <option value="IAAC">IAAC</option>
        <option value="CESI">CESI</option>
      </select>
    </div>
    <div style="display: grid">
      <input id="layerUuidCustom" style="margin-top: 10px; margin-bottom: 10px; width: 300px" />
      <textarea id="layerUuidCustomEntries" cols="80" rows="25"></textarea>
    </div>
    <ul>
      <li>
        <button id="addLayersCustom" style="margin: 10px">Add Layers</button>
        Add entered Geocore UUID's to the map with a custom configuration (List of layer entries)
        <details>
          <summary>Code</summary>
          <pre>
              cgpv.api.maps.Map1.layer.addGeoviewLayerByGeoCoreUUID(uuid, customListOfLayerEntries);
          </pre>
        </details>
      </li>
      <li>
        <textarea id="customLayerNames" cols="100" rows="4"></textarea>
        <br>
        <button id="changeNamesCustom" style="margin: 10px">Change Names</button>
        Updates the current map config, replacing some of the default layer names (from above) and refreshes the map.
        Note: if the currently stored map config does not contain the default layers, the map will refresh with nothing changed.
        To execute properly - Add Layers, Update State, Change Names - Update Names and Change Names again will change them back.
        <details>
          <summary>Code</summary>
          <pre>
            const pairs = [["Radioactivité de l'air", 'Radioactivity'], ['Périmètre de localisation des stations', 'Perimeter'], ['Carte commémorative du Canada', 'Commemorative Map']];
            cgpv.api.maps.Map1.replaceMapConfigLayerNames(pairs, mapConfig);
            refreshMap();
          </pre>
        </details>
      </li>
    </ul>

    <script src="codedoc.js"></script>
    <script>
      // Empty map config
      let mapConfig = {
        map: {
          interaction: 'dynamic',
          viewSettings: {
            projection: 3857,
          },
          basemapOptions: {
            basemapId: 'transport',
            shaded: false,
            labeled: true,
          },
          listOfGeoviewLayerConfig: [],
        },
        components: ['overview-map'],
        navBar: ['zoom', 'fullscreen', 'home', 'location', 'basemap-select'],
        appBar: {
          tabs: {
            core: ['geolocator', 'export'],
          },
        },
        footerBar: {
          tabs: {
            core: ['legend', 'layers', 'details', 'data-table', 'time-slider', 'geochart'],
          },
        },
        corePackages: [],
        theme: 'geo.ca',
      };

      let lang = 'fr';

      function createMapDiv() {
        if (!document.getElementById('Map1')) {
          // Create the div
          const newDiv = document.createElement('div');

          // Create id and data-lang attributes and add them to div
          const id = document.createAttribute('id');
          id.value = 'Map1';
          newDiv.setAttributeNode(id);
          const dataLang = document.createAttribute('data-lang');
          dataLang.value = lang;
          newDiv.setAttributeNode(dataLang);

          // Append the div to the mapSection div
          document.getElementById('mapSection').appendChild(newDiv);
        }
      }

      /** OSDP function
       * Removes a map if it exists.
       *
       * @param map The map id.
       * @returns Promise<void>
       */
      function removeMap(map) {
        return new Promise((resolve) => {
          if (cgpv.api.maps[map]) {
            cgpv.api.maps[map].remove(false).then(() => {
              resolve();
            });
          } else {
            resolve();
          }
        });
      }

      /** OSDP function
       * Adds layers to the map.
       *
       * @param layers Array of layers.
       */
      function addLayers(layers) {
        layers.forEach((layer) => {
          cgpv.api.maps.Map1.layer.addGeoviewLayerByGeoCoreUUID(layer);
        });
      }

      /** OSDP function
       * Refresh the map.
       *
       * @param layers Array of layers.
       */
      function refreshMap() {
        return new Promise((resolve) => {
          removeMap('Map1').then(() => {
            cgpv.api.createMapFromConfig('Map1', JSON.stringify(mapConfig), 800).then(() => {
              resolve();
            });
          });
        });
      }

      // Delete Button============================================================================================================
      const deleteMapButton = document.getElementById('deleteMap');

      // add an event listener when a button is clicked
      deleteMapButton.addEventListener('click', function () {
        // Delete map div
        document.getElementById('Map1').remove();
      });

      // Create Button============================================================================================================
      const createMapButton = document.getElementById('createMap');

      // add an event listener when a button is clicked
      createMapButton.addEventListener('click', createMapDiv);

      // Refresh Button============================================================================================================
      const refreshMapButton = document.getElementById('refreshMap');

      // add an event listener when a button is clicked
      refreshMapButton.addEventListener('click', function () {
        createMapDiv();
        refreshMap();
      });

      // Update Button============================================================================================================
      const updateMapButton = document.getElementById('updateState');

      // add an event listener when a button is clicked
      updateMapButton.addEventListener('click', function () {
        mapConfig = cgpv.api.maps.Map1.createMapConfigFromMapState();
        console.log(mapConfig);
      });

      // Change Language Button============================================================================================================
      const changeLanguageButton = document.getElementById('changeLanguage');

      // add an event listener when a button is clicked
      changeLanguageButton.addEventListener('click', function () {
        lang = lang === 'fr' ? 'en' : 'fr';
        const mapDiv = document.getElementById('Map1');
        if (mapDiv) {
          mapDiv.setAttribute('data-lang', lang);
          cgpv.api.maps.Map1.reloadWithCurrentState(false);
        }
      });

      // Add Layers Button============================================================================================================
      const addLayersButton = document.getElementById('addLayers');

      // add an event listener when a button is clicked
      addLayersButton.addEventListener('click', function () {
        if (document.getElementById('Map1')) {
          const layerUuids = document.getElementById('layerUuids').value;
          const uuidList = layerUuids.split('\n').join(',').split(',');
          addLayers(uuidList);
        }
      });

      // Change Names Button============================================================================================================
      const changeNamesButton = document.getElementById('changeNames');

      // add an event listener when a button is clicked
      changeNamesButton.addEventListener('click', function () {
        const pairs = document.getElementById('layerNames').value.replace(/\[|\]/g,'').split(',').map((name) => name.trim()).reduce((result, value, index, array) => {
          if (index % 2 === 0)
            result.push(array.slice(index, index + 2));
            return result;
          }, []);
        console.log(pairs);
        cgpv.api.maps.Map1.replaceMapConfigLayerNames(pairs, mapConfig);
        refreshMap();
      });

      // Change Names Custom Button============================================================================================================
      const changeNamesCustomButton = document.getElementById('changeNamesCustom');

      // add an event listener when a button is clicked
      changeNamesCustomButton.addEventListener('click', function () {
        const pairs = document.getElementById('customLayerNames').value.replace(/\[|\]/g,'').split(',').map((name) => name.trim()).reduce((result, value, index, array) => {
          if (index % 2 === 0)
            result.push(array.slice(index, index + 2));
            return result;
          }, []);
        console.log(pairs);
        cgpv.api.maps.Map1.replaceMapConfigLayerNames(pairs, mapConfig);
        refreshMap();
      });

      const uuidConfig = {
        AirborneRadioactivity: '21b821cf-0f1c-40ee-8925-eab12d357668',
        AirborneRadioactivityNames: "[Airborne Radioactivity - Feature Layer, Radioactivité de l'air]",
        AirborneRadioactivityConfig: [
          {
            layerId: '0',
            entryType: 'group',
            layerName: 'Airborne Radioactivity - Main Group',
            listOfLayerEntryConfig: [
              {
                layerId: '1',
                layerName: 'Airborne Radioactivity - Feature Layer',
                initialSettings: {
                  states: {
                    visible: false,
                  },
                },
              },
            ],
          },
        ],
        IAAC: 'f4c51eaa-a6ca-48b9-a1fc-b0651da20509',
        IAACNames: "[IAAC Projects, IAAC Group]",
        IAACConfig: [
          {
            entryType: 'group',
            layerName: 'IAAC Projects',
            listOfLayerEntryConfig: [
              {
                layerId: '0',
                initialSettings: {
                  states: {
                    legendCollapsed: true,
                    visible: false,
                  },
                },
              },
              {
                layerId: '1',
                initialSettings: {
                  states: {
                    legendCollapsed: false,
                    visible: true,
                  },
                },
              },
              {
                layerId: '2',
                initialSettings: {
                  states: {
                    legendCollapsed: true,
                    visible: false,
                  },
                },
              },
            ],
          },
        ],
        CESI: '5a65ad7c-561a-466a-8375-8d876624df9d',
        CESINames: "[CESI - Water Quality Group, Water Quality Group]",
        CESIConfig: [
          {
            layerId: '0',
            entryType: 'group',
            layerName: 'CESI - Water Quantity Group',
            listOfLayerEntryConfig: [
              {
                layerId: '1',
                initialSettings: {
                  states: {
                    visible: false,
                  },
                },
              },
            ],
          },
          {
            layerId: '4',
            entryType: 'group',
            layerName: 'CESI - Water Quality Group',
            initialSettings: {
              states: {
                visible: false,
                legendCollapsed: true,
              },
            },
            listOfLayerEntryConfig: [
              {
                layerId: '5',
              },
              {
                layerId: '6',
              },
              {
                layerId: '7',
              },
            ],
          },
        ],
      };


      // Add Layers Custom Button============================================================================================================
      const addLayersCustomButton = document.getElementById('addLayersCustom');

      // add an event listener when a button is clicked
      addLayersCustomButton.addEventListener('click', function () {
        if (document.getElementById('Map1')) {
          const layerUuid = document.getElementById('layerUuidCustom').value;
          const layerUuidEntries = document.getElementById('layerUuidCustomEntries').value;

          if (layerUuidEntries === '') cgpv.api.maps.Map1.layer.addGeoviewLayerByGeoCoreUUID(layerUuid);
          else cgpv.api.maps.Map1.layer.addGeoviewLayerByGeoCoreUUID(layerUuid, layerUuidEntries);
        }
      });

      // Add a samples selector
      const layerUuid = document.getElementById('layerUuidCustom');
      const layerUuidEntries = document.getElementById('layerUuidCustomEntries');
      const customLayerNames = document.getElementById('customLayerNames');
      layerUuid.value = uuidConfig['AirborneRadioactivity'];
      layerUuidEntries.value = JSON.stringify(uuidConfig[`AirborneRadioactivityConfig`], null, 2);
      customLayerNames.value = uuidConfig['AirborneRadioactivityNames'];

      const switchCustom = document.getElementById('switchCustom');
      switchCustom.addEventListener('change', (e) => {
        const layerUuid = document.getElementById('layerUuidCustom');
        const layerUuidEntries = document.getElementById('layerUuidCustomEntries');
        const customLayerNames = document.getElementById('customLayerNames');

        layerUuid.value = uuidConfig[e.target.value.replaceAll(' ', '')];
        layerUuidEntries.value = JSON.stringify(uuidConfig[`${e.target.value.replaceAll(' ', '')}Config`], null, 2);
        customLayerNames.value = uuidConfig[`${e.target.value.replaceAll(' ', '')}Names`];
      });

      // initialize cgpv and api events, a callback is optional, used if calling api's after the rendering is ready
      cgpv.init();
    </script>
  </body>
</html>

<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>OSDP Integration - Canadian Geospatial Platform Viewer</title>
    <link rel="shortcut icon" href="./favicon.ico" />
    <meta name="msapplication-TileColor" content="#da532c" />
    <meta name="msapplication-config" content="./img/browserconfig.xml" />
    <meta name="theme-color" content="#ffffff" />
    <meta name="msapplication-TileColor" content="#da532c" />
    <meta name="theme-color" content="#ffffff" />
    <link href="https://fonts.googleapis.com/css?family=Roboto|Montserrat:200,300,400,900|Merriweather" rel="stylesheet" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons" />
    <link rel="stylesheet" href="css/style.css" />
  </head>

  <body>
    <div id="page-header"></div>
    <div>
      <div class="back-to-main">
        <a href="./index.html?tab=specific-demos">← Back to Main</a>
      </div>

      <div class="demo-section">
        <h4>OSDP Integration</h4>
        <p>Open Science and Data Platform integration with GeoView.</p>
      </div>
    </div>

    <div class="map-title-holder">
      <h4 id="HMap1">OSDP Integration</h4>
    </div>

    <div id="mapSection">
      <div
        id="Map1"
        class="geoview-map"
        data-lang="fr"
        data-config="{
        'map': {
          'interaction': 'dynamic',
          'viewSettings': {
            'projection': 3857,
            'homeView': {
              'zoomAndCenter': [8, [-71.26, 46.8]]
            }
          },
          'basemapOptions': {
            'basemapId': 'transport',
            'shaded': false,
            'labeled': true
          },
          'listOfGeoviewLayerConfig': []
        },
        'components': ['overview-map'],
        'navBar': ['zoom', 'fullscreen', 'home', 'location', 'basemap-select'],
        'appBar': {
          'tabs': {
            'core': ['legend', 'details', 'geolocator', 'export']
          }
        },
        'footerBar': {
          'tabs': {
            'core': ['layers', 'data-table', 'time-slider', 'geochart']
          }
        },
        'corePackages': [],
        'serviceUrls': {
          'metadataUrl': 'https://osdp-psdo.canada.ca/dp/en/search/metadata/NRCAN-FGP-1-'
        },
        'theme': 'geo.ca'
      }"
      ></div>
    </div>

    <div class="demo-section">
      <h4>Changes to map div</h4>
      <div style="display: flex; gap: 20px; align-items: flex-start">
        <div>
          <button
            class="btn btn-primary"
            id="deleteMap"
            title="Deletes map div if it exists (deleting and unmounting the MapViewer in the process)."
          >
            Delete map div
          </button>
          <details>
            <summary>Code</summary>
            <pre>document.getElementById('Map1').remove();</pre>
          </details>
        </div>

        <div>
          <button class="btn btn-primary" id="createMap" title="Creates a new div for the map, if the original div has been deleted">
            Create map div
          </button>
          <details>
            <summary>Code</summary>
            <pre>
if (!document.getElementById('Map1')) {
  const newDiv = document.createElement('div');
  const id = document.createAttribute('id');
  id.value = 'Map1';
  newDiv.setAttributeNode(id);
  const dataLang = document.createAttribute('data-lang');
  dataLang.value = lang;
  newDiv.setAttributeNode(dataLang);
  document.getElementById('mapSection').appendChild(newDiv);
}
          </pre
            >
          </details>
        </div>

        <div>
          <button
            class="btn btn-primary"
            id="changeLanguage"
            title="Changes the div language setting from french to english or english to french."
          >
            Change <code>data-lang</code> Attribute
          </button>
          <p>Currently: <i id="dataLang">fr</i></p>
          <p>Note: Will not effect the map until reloaded.</p>
          <details>
            <summary>Code</summary>
            <pre>
lang = lang === 'fr' ? 'en' : 'fr';
const mapDiv = document.getElementById('Map1');
if (mapDiv) {
  mapDiv.setAttribute('data-lang', lang);
            }
          </pre
            >
          </details>
        </div>
      </div>
    </div>
    <br /><br />

    <div class="demo-section">
      <h4>Add Layers</h4>
      <div style="display: flex; gap: 20px; align-items: flex-start">
        <div>
          <textarea id="layerUuids" cols="40" rows="5">
21b821cf-0f1c-40ee-8925-eab12d357668,ccc75c12-5acc-4a6a-959f-ef6f621147b9,0fca08b5-e9d0-414b-a3c4-092ff9c5e326</textarea
          >
          <br />
          <button
            class="btn btn-primary"
            id="addLayers"
            title="Add entered Geocore UUID's to the map. Can be separated with commas or each on a new line"
          >
            Add Layers
          </button>
          <details>
            <summary>Code</summary>
            <pre>
if (document.getElementById('Map1')) {
  const layerUuids = document.getElementById('layerUuids').value;
  const uuidList = layerUuids.split('\n').join(',').split(',');
  addLayers(uuidList);
}

function addLayers(layers) {
  layers.forEach((layer) => {
    cgpv.api.getMapViewer('Map1').layer.addGeoviewLayerByGeoCoreUUID(layer);
  });
}
            </pre>
          </details>
        </div>
        <div style="display: flex; flex-direction: column; gap: 10px">
          <div class="selector">
            <select name="Select custom config" id="switchCustom" class="form-select">
              <option value="Airborne Radioactivity">Airborne Radioactivity</option>
              <option value="IAAC">IAAC</option>
              <option value="CESI">CESI</option>
              <option value="DFO">DFO</option>
              <option value="landCover">Land Cover 2010</option>
            </select>
            <input id="layerUuidCustom" class="form-control" />
          </div>

          <div>
            <textarea id="layerUuidCustomEntries" cols="80" rows="25"></textarea>
          </div>
          <div>
            <button
              class="btn btn-primary"
              id="addLayersCustom"
              title="Add entered Geocore UUID's to the map with a custom configuration (List of layer entries)"
            >
              Add Layers With Custom Config
            </button>
            <details>
              <summary>Code</summary>
              <pre>cgpv.api.getMapViewer('Map1').layer.addGeoviewLayerByGeoCoreUUID(uuid, customListOfLayerEntries);</pre>
            </details>
          </div>
        </div>
      </div>
    </div>
    <br /><br />

    <div class="demo-section">
      <h4>Current Stored Config</h4>
      <div style="display: flex; gap: 20px; align-items: flex-start">
        <div>
          <button
            class="btn btn-primary"
            id="refreshMap"
            title="Recreates the map using the config below, creating a new div if it has been deleted"
          >
            Refresh map
          </button>
          <details>
            <summary>Code</summary>
            <pre>
            async function refreshMap() {
              try {
                // Remove the map
                await removeMap('Map1');

                // Create map from config
                await cgpv.api.createMapFromConfig('Map1', JSON.stringify(mapConfig), 800).then((mapViewer) => {
                  if (langSwitch) {
                      mapViewer.notifications.showWarning('Map language changed', []);
                      mapViewer.notifications.addNotificationWarning(`MapViewer: Map language changed to ${lang}`);
                  }

                  // OSDP event trapping for notification
                  // Listen to layer removed event
                  mapViewer.layer.onLayerConfigRemoved((sender, payload) => {
                    mapViewer.notifications.addNotificationSuccess('LayerApi: ' + payload.layerName + ' removed'); // does not show on map
                    mapViewer.notifications.showMessage('Layer '  + payload.layerName + ' removed', [], true); // true will add a notification
                  });
                });
              } catch (error) {
                console.error('Failed to create map from config', error);
              }
            }

            async function removeMap(mapId) {
              if (cgpv.api.hasMapViewer(mapId)) {
                  await cgpv.api.deleteMapViewer(mapId, false);
              }
            }
          </pre
            >
          </details>
        </div>
        <div>
          <button class="btn btn-primary" id="updateState" title="Updates the stored config with the current map state">
            Update Config With Current Map State
          </button>
          <div class="selector">
            <label for="keepNames">Override Geocore Service Names:</label>
            <select name="keepNames" id="keepNames" class="form-select">
              <option value="true">true</option>
              <option value="false">false</option>
              <option value="hybrid">hybrid</option>
            </select>
          </div>
          <details>
            <summary>Modes</summary>
            <pre>
true - All names are kept as they appear on the map
false - All geocore names are set to undefined, to be reapplied by the service
hybrid - Geocore layer names are kept, style to be reapplied by the service
          </pre
            >
          </details>
          <details>
            <summary>Code</summary>
            <pre>mapConfig = cgpv.api.getMapViewer('Map1').createMapConfigFromMapState(overrideGeocoreServiceNames);</pre>
          </details>
        </div>
      </div>
    </div>
    <br />

    <div>
      <textarea id="configTextArea" cols="100" rows="50" readonly> </textarea>
    </div>

    <div class="demo-section">
      <h4>Change the layer names in the config</h4>
      <p>
        The examples provided below are for the default three layers in the add layers box above. To see this work, click the "Add Layers"
        button with the default layers, click "Update With Map State" once the layers are loaded, and then click "Change Names". The names
        in the config will be updated.
      </p>
      <p>
        To try it yourself, add any layer to the map, update the config, and then copy the layer name you would like to change. Put it in
        square brackets in the box below, followed by a comma, and then the name you would like to replace it with - [name to change, new
        name]. Note that the order of the names in the pair, and the order of the pairs do not matter, [Radioactivité de l'air,
        Radioactivity] and [Radioactivity, Radioactivité de l'air] will function the same - any provided layer name will be replaced with
        its pair, so the same call can be used to switch a name and switch it back.
      </p>
      <textarea id="layerNames" cols="100" rows="4">
[Radioactivité de l'air, Radioactivity], [Périmètre de localisation des stations, Perimeter], [Carte commémorative du Canada, Commemorative Map]</textarea
      >
      <br />
      <div style="display: flex; gap: 20px; align-items: flex-start">
        <div>
          <button class="btn btn-primary" id="changeNames" title="Replaces listed layer names with thei provided pair in the config">
            Change Names
          </button>
          <details>
            <summary>Code</summary>
            <pre>
const pairs = [["Radioactivité de l'air", 'Radioactivity'], ['Périmètre de localisation des stations', 'Perimeter'], ['Carte commémorative du Canada', 'Commemorative Map']];
cgpv.api.getMapViewer('Map1').replaceMapConfigLayerNames(pairs, mapConfig);
        </pre
            >
          </details>
        </div>
        <div>
          <button
            class="btn btn-primary"
            id="changeNamesAndRemove"
            title="Replaces listed layer names with thei provided pair in the config, and removes any names that aren't listed"
          >
            Change Names and Remove Unlisted
          </button>
          <details>
            <summary>Code</summary>
            <pre>
const pairs = [["Radioactivité de l'air", 'Radioactivity'], ['Périmètre de localisation des stations', 'Perimeter'], ['Carte commémorative du Canada', 'Commemorative Map']];
cgpv.api.getMapViewer('Map1').replaceMapConfigLayerNames(pairs, mapConfig, true);
        </pre
            >
          </details>
        </div>
      </div>
    </div>
    <br /><br />

    <script src="codedoc.js"></script>
    <script>
      insertPageHeader();

      // Empty map config
      let mapConfig = {
        map: {
          interaction: 'dynamic',
          viewSettings: {
            projection: 3857,
            homeView: {
              zoomAndCenter: [8, [-71.26, 46.8]],
            },
          },
          basemapOptions: {
            basemapId: 'transport',
            shaded: false,
            labeled: true,
          },
          listOfGeoviewLayerConfig: [],
        },
        components: ['overview-map'],
        navBar: ['zoom', 'fullscreen', 'home', 'location', 'basemap-select'],
        appBar: {
          tabs: {
            core: ['legend', 'details', 'geolocator', 'export'],
          },
        },
        footerBar: {
          tabs: {
            core: ['layers', 'data-table', 'time-slider', 'geochart'],
          },
        },
        corePackages: [],
        serviceUrls: {
          metadataUrl: 'https://osdp-psdo.canada.ca/dp/en/search/metadata/NRCAN-FGP-1-',
        },
        theme: 'geo.ca',
      };

      let lang = 'fr';
      let langSwitch = false;

      function updateConfigTextArea() {
        const configTextArea = document.getElementById('configTextArea');
        configTextArea.value = JSON.stringify(mapConfig, null, 2);
      }

      updateConfigTextArea();

      function createMapDiv() {
        if (!document.getElementById('Map1')) {
          // Create the div
          const newDiv = document.createElement('div');

          // Create id and data-lang attributes and add them to div
          const id = document.createAttribute('id');
          id.value = 'Map1';
          newDiv.setAttributeNode(id);
          const dataLang = document.createAttribute('data-lang');
          dataLang.value = lang;
          newDiv.setAttributeNode(dataLang);

          // Append the div to the mapSection div
          document.getElementById('mapSection').appendChild(newDiv);
        }
      }

      /** OSDP function
       * Removes a map if it exists.
       *
       * @param map The map id.
       * @returns Promise<void>
       */
      async function removeMap(mapId) {
        if (cgpv.api.hasMapViewer(mapId)) {
          await cgpv.api.deleteMapViewer(mapId, false);
        }
      }

      /** OSDP function
       * Refresh the map.
       *
       * @param layers Array of layers.
       */
      async function refreshMap() {
        try {
          // Remove the map
          await removeMap('Map1');

          // Create map from config
          await cgpv.api.createMapFromConfig('Map1', JSON.stringify(mapConfig), 800).then((mapViewer) => {
            if (langSwitch) {
              mapViewer.notifications.showWarning('Map language changed', []);
              mapViewer.notifications.addNotificationWarning(`MapViewer: Map language changed to ${lang}`);
            }

            // OSDP event trapping for notification
            // Listen to layer removed event
            mapViewer.layer.onLayerConfigRemoved((sender, payload) => {
              mapViewer.notifications.addNotificationSuccess('LayerApi: ' + payload.layerName + ' removed'); // does not show on map
              mapViewer.notifications.showMessage('Layer ' + payload.layerName + ' removed', [], true); // true will add a notification
            });
          });
        } catch (error) {
          console.error('Failed to create map from config', error);
        }
      }

      /** OSDP function
       * Adds layers to the map.
       *
       * @param layers Array of layers.
       */
      function addLayers(layers) {
        layers.forEach((layer, i) => {
          if (layers.indexOf(layer) < i) {
            layer = `${layer}:${crypto.randomUUID()}`;
          }
          cgpv.api.getMapViewer('Map1').layer.addGeoviewLayerByGeoCoreUUID(layer);
        });
      }

      // Delete Button============================================================================================================
      const deleteMapButton = document.getElementById('deleteMap');

      // add an event listener when a button is clicked
      deleteMapButton.addEventListener('click', function () {
        // Delete map div
        document.getElementById('Map1').remove();
      });

      // Create Button============================================================================================================
      const createMapButton = document.getElementById('createMap');

      // add an event listener when a button is clicked
      createMapButton.addEventListener('click', createMapDiv);

      // Refresh Button============================================================================================================
      const refreshMapButton = document.getElementById('refreshMap');

      // add an event listener when a button is clicked
      refreshMapButton.addEventListener('click', function () {
        createMapDiv();
        refreshMap();
      });

      // Update Config Button============================================================================================================
      const updateConfigButton = document.getElementById('updateState');

      // add an event listener when a button is clicked
      updateConfigButton.addEventListener('click', function () {
        const keepNames = document.getElementById('keepNames').value;
        const overrideGeocoreServiceNames = keepNames === 'hybrid' ? 'hybrid' : keepNames === 'true';
        mapConfig = cgpv.api.getMapViewer('Map1').createMapConfigFromMapState(overrideGeocoreServiceNames);
        console.log(mapConfig);
        updateConfigTextArea();
      });

      // Change Language Button============================================================================================================
      const changeLanguageButton = document.getElementById('changeLanguage');

      // add an event listener when a button is clicked
      changeLanguageButton.addEventListener('click', function () {
        lang = lang === 'fr' ? 'en' : 'fr';
        langSwitch = true;
        document.getElementById('dataLang').innerHTML = lang;
        const mapDiv = document.getElementById('Map1');
        if (mapDiv) mapDiv.setAttribute('data-lang', lang);
      });

      // Add Layers Button============================================================================================================
      const addLayersButton = document.getElementById('addLayers');

      // add an event listener when a button is clicked
      addLayersButton.addEventListener('click', function () {
        if (document.getElementById('Map1')) {
          const layerUuids = document.getElementById('layerUuids').value;
          const uuidList = layerUuids.split('\n').join(',').split(',');
          addLayers(uuidList);
        }
      });

      // Change Names Button============================================================================================================
      const changeNamesButton = document.getElementById('changeNames');

      // add an event listener when a button is clicked
      changeNamesButton.addEventListener('click', function () {
        const pairs = document
          .getElementById('layerNames')
          .value.replace(/\[|\]/g, '')
          .split(',')
          .map((name) => name.trim())
          .reduce((result, value, index, array) => {
            if (index % 2 === 0) result.push(array.slice(index, index + 2));
            return result;
          }, []);
        cgpv.api.getMapViewer('Map1').replaceMapConfigLayerNames(pairs, mapConfig);
        updateConfigTextArea();
      });

      // Change Names and Remove Button============================================================================================================
      const changeNamesAndRemoveButton = document.getElementById('changeNamesAndRemove');

      // add an event listener when a button is clicked
      changeNamesAndRemoveButton.addEventListener('click', function () {
        const pairs = document
          .getElementById('layerNames')
          .value.replace(/\[|\]/g, '')
          .split(',')
          .map((name) => name.trim())
          .reduce((result, value, index, array) => {
            if (index % 2 === 0) result.push(array.slice(index, index + 2));
            return result;
          }, []);
        cgpv.api.getMapViewer('Map1').replaceMapConfigLayerNames(pairs, mapConfig, true);
        updateConfigTextArea();
      });

      const uuidConfig = {
        AirborneRadioactivity: '21b821cf-0f1c-40ee-8925-eab12d357668',
        AirborneRadioactivityConfig: [
          {
            layerId: '0',
            entryType: 'group',
            layerName: 'Airborne Radioactivity - Main Group',
            listOfLayerEntryConfig: [
              {
                layerId: '1',
                layerName: 'Airborne Radioactivity - Feature Layer',
                initialSettings: {
                  states: {
                    visible: false,
                  },
                },
              },
            ],
          },
        ],
        IAAC: 'f4c51eaa-a6ca-48b9-a1fc-b0651da20509',
        IAACConfig: [
          {
            entryType: 'group',
            layerName: 'IAAC Projects',
            listOfLayerEntryConfig: [
              {
                layerId: '0',
                initialSettings: {
                  states: {
                    legendCollapsed: true,
                    visible: false,
                  },
                },
              },
              {
                layerId: '1',
                initialSettings: {
                  states: {
                    legendCollapsed: false,
                    visible: true,
                  },
                },
              },
              {
                layerId: '2',
                initialSettings: {
                  states: {
                    legendCollapsed: true,
                    visible: false,
                  },
                },
              },
            ],
          },
        ],
        CESI: '5a65ad7c-561a-466a-8375-8d876624df9d',
        CESIConfig: [
          {
            layerId: '0',
            entryType: 'group',
            layerName: 'CESI - Water Quantity Group',
            listOfLayerEntryConfig: [
              {
                layerId: '1',
                initialSettings: {
                  states: {
                    visible: false,
                  },
                },
              },
            ],
          },
          {
            layerId: '4',
            entryType: 'group',
            layerName: 'CESI - Water Quality Group',
            initialSettings: {
              states: {
                visible: false,
                legendCollapsed: true,
              },
            },
            listOfLayerEntryConfig: [
              {
                layerId: '5',
              },
              {
                layerId: '6',
              },
              {
                layerId: '7',
              },
            ],
          },
        ],
        DFO: 'db177a8c-5d7d-49eb-8290-31e6a45d786c',
        DFOConfig: [
          {
            layerName: 'Critical Habitat for Aquatic Species at Risk - Canada',
          },
        ],
        landCover: 'c688b87f-e85f-4842-b0e1-a8f79ebf1133',
        landCoverConfig: [
          {
            layerId: 'landcover-2010',
            layerName: '2010 Land Cover of Canada',
            initialSettings: {
              states: {
                legendCollapsed: true,
                visible: false,
              },
            },
          },
        ],
      };

      // Add Layers Custom Button============================================================================================================
      const addLayersCustomButton = document.getElementById('addLayersCustom');

      // add an event listener when a button is clicked
      addLayersCustomButton.addEventListener('click', function () {
        if (document.getElementById('Map1')) {
          const layerUuid = document.getElementById('layerUuidCustom').value;
          const layerUuidEntries = document.getElementById('layerUuidCustomEntries').value;

          if (layerUuidEntries === '') cgpv.api.getMapViewer('Map1').layer.addGeoviewLayerByGeoCoreUUID(layerUuid);
          else cgpv.api.getMapViewer('Map1').layer.addGeoviewLayerByGeoCoreUUID(layerUuid, layerUuidEntries);
        }
      });

      // Add a samples selector
      const layerUuid = document.getElementById('layerUuidCustom');
      const layerUuidEntries = document.getElementById('layerUuidCustomEntries');
      layerUuid.value = uuidConfig['AirborneRadioactivity'];
      layerUuidEntries.value = JSON.stringify(uuidConfig[`AirborneRadioactivityConfig`], null, 2);

      const switchCustom = document.getElementById('switchCustom');
      switchCustom.addEventListener('change', (e) => {
        const layerUuid = document.getElementById('layerUuidCustom');
        const layerUuidEntries = document.getElementById('layerUuidCustomEntries');

        layerUuid.value = uuidConfig[e.target.value.replaceAll(' ', '')];
        layerUuidEntries.value = JSON.stringify(uuidConfig[`${e.target.value.replaceAll(' ', '')}Config`], null, 2);
      });

      // OSDP event trapping for notification
      cgpv.onMapInit((mapViewer) => {
        // listen to map language changed event
        mapViewer.onMapLanguageChanged((sender, payload) => {
          mapViewer.notifications.addNotificationWarning(`MapViewer: Map language changed to ${payload.language}`);
          mapViewer.notifications.showWarning('Map language changed', []);
        });

        // Listen to layer removed event
        mapViewer.layer.onLayerConfigRemoved((sender, payload) => {
          mapViewer.notifications.addNotificationSuccess('LayerApi: ' + payload.layerName + ' removed'); // does not show on map
          mapViewer.notifications.showMessage('Layer ' + payload.layerName + ' removed', [], true); // true will add a notification
        });
      });

      // initialize cgpv
      cgpv.init();
    </script>
  </body>
</html>

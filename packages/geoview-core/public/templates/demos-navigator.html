<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Configurations Navigator - Canadian Geospatial Platform Viewer</title>
    <link rel="shortcut icon" href="./favicon.ico" />
    <meta name="msapplication-TileColor" content="#da532c" />
    <meta name="msapplication-config" content="./img/browserconfig.xml" />
    <meta name="theme-color" content="#ffffff" />
    <meta name="msapplication-TileColor" content="#da532c" />
    <meta name="theme-color" content="#ffffff" />
    <link rel="stylesheet" href="css/style.css" />
    <style>
      .actionButton {
        padding: 5px;
      }

      .selector-container {
        display: flex;
        flex-direction: row;
        margin: 10px;
      }

      .selector {
        padding: 15px;
      }

      .editor {
        display: inline-flex;
        gap: 10px;
        font-family: monospace;
        line-height: 21px;
        background: #282a3a;
        border-radius: 2px;
        padding: 20px 10px;
        height: 600px;
        overflow-y: auto;
      }

      .line-numbers {
        width: 20px;
        text-align: right;
        height: 9999px;
      }

      .line-numbers span {
        counter-increment: linenumber;
      }

      .line-numbers span::before {
        content: counter(linenumber);
        display: block;
        color: #506882;
      }

      textarea {
        height: 9999px;
        line-height: 21px;
        overflow-y: hidden;
        padding: 0;
        border: 0;
        background: #282a3a;
        color: #fff;
        min-width: 500px;
        outline: none;
        resize: none;
      }

      select {
        max-width: 96%;
      }

      @media screen and (max-width: 600px) {
        .selector-container {
          display: flex;
          flex-direction: column;
          width: 100%;
        }
        .selector-container p {
          margin-bottom: 0px;
        }
        .selector {
          padding: 8px;
        }
        textarea {
          min-width: 96%;
          max-width: 96%;
        }
      }
    </style>
  </head>

  <body>
    <div class="header-table">
      <table>
        <tbody>
          <tr>
            <td><img class="header-logo" alt="logo" src="./img/Logo.png" /></td>
            <td class="header-title">
              <h1><strong>Configurations Navigator</strong></h1>
            </td>
          </tr>
        </tbody>
      </table>
      <table>
        <tbody>
          <tr>
            <td><a href="./index.html">Main</a><br /></td>
          </tr>
        </tbody>
      </table>
    </div>

    <hr />
    <div class="selector-container">
      <p>Configuration to load:</p>
      <div class="selector">
        <select name="Config Loader" id="configLoader">
          <option value="">--select--</option>
          <option value="./configs/navigator/01-basemap-LCC-TLS.json">Basemap LCC Transport-Labeled-Shaded</option>
          <option value="./configs/navigator/02-basemap-LCC-SL.json">
            Basemap LCC Simple-Labeled (overview map hide on zoom 7 and lower)
          </option>
          <option value="./configs/navigator/03-projection-WM.json">Basemap WM</option>
          <option value="./configs/navigator/04-restrict-zoom.json">Restricted zoom [4, 8]</option>
          <option value="./configs/navigator/04-a-max-extent-override.json">Unrestricted zoom map extent for WM zoom north</option>
          <option value="./configs/navigator/05-zoom-layer.json">Zoom on layer extent</option>
          <option value="./configs/navigator/05-layer-zoom-levels.json">Zoom and Scale Settings</option>
          <option value="./configs/navigator/05-all-layer-zoom-levels.json">All Layer Type Zoom and Scale</option>
          <option value="./configs/navigator/06-basic-footer-layers-tab.json">Basic map with footer - Layers Default</option>
          <option value="./configs/navigator/06-basic-footer-data-table-tab.json">Basic map with footer - Data Table Default</option>
          <option value="./configs/navigator/07-basic-appbar-layers-tab.json">Basic map with app bar - Layers Default</option>
          <option value="./configs/navigator/07-basic-appbar-data-table-tab.json">Basic map with app bar - Data Table Default</option>
          <option value="./configs/navigator/07-basic-footer-appbar-combo.json">Basic map with app bar footer bar combo</option>
          <option value="./configs/navigator/26-package-area-of-interest.json">Package Area of interest</option>
          <option value="./configs/navigator/30-package-custom-legend.json">Package Custom Legend</option>
          <option value="./configs/navigator/31-global-settings.json">Global Settings Options</option>
          <option value="./configs/navigator/10-package-time-slider.json">Package time slider</option>
          <option value="./configs/navigator/11-package-time-slider-custom.json">Package custom time slider</option>
          <option value="./configs/navigator/12-package-geochart.json">Package geochart</option>
          <option value="./configs/navigator/12-a-package-swiper.json">Package swiper</option>
          <option value="./configs/navigator/13-all-layers.json">All Layer Types</option>
          <option value="./configs/navigator/14-wms-layer.json">Layer - WMS -</option>
          <option value="./configs/navigator/14-wms-layer-errors.json">Layer - WMS - errors</option>
          <option value="./configs/navigator/15-xyz-tile.json">Layer - XYZ Tile -</option>
          <option value="./configs/navigator/15-xyz-tile-errors.json">Layer - XYZ Tile - errors</option>
          <option value="./configs/navigator/16-esri-dynamic.json">Layer - ESRI Dynamic -</option>
          <option value="./configs/navigator/16-esri-dynamic-projections.json">Layer - ESRI Dynamic - projections</option>
          <option value="./configs/navigator/16-esri-dynamic-errors.json">Layer - ESRI Dynamic - errors</option>
          <option value="./configs/navigator/17-esri-feature.json">Layer - ESRI Feature -</option>
          <option value="./configs/navigator/17-esri-feature-errors.json">Layer - ESRI Feature - errors</option>
          <option value="./configs/navigator/18-esri-image.json">Layer - ESRI Image -</option>
          <option value="./configs/navigator/18-esri-image-errors.json">Layer - ESRI Image - errors</option>
          <option value="./configs/navigator/19-geojson.json">Layer - GeoJSON -</option>
          <option value="./configs/navigator/19-geojson-errors.json">Layer - GeoJSON - errors</option>
          <option value="./configs/navigator/20-wfs.json">Layer - WFS -</option>
          <option value="./configs/navigator/20-wfs-errors.json">Layer - WFS - errors</option>
          <option value="./configs/navigator/21-ogc-feature-api.json">Layer - OGC Feature API -</option>
          <option value="./configs/navigator/21-ogc-feature-api-errors.json">Layer - OGC Feature API - errors</option>
          <option value="./configs/navigator/22-static-image.json">Layer - Static Image -</option>
          <option value="./configs/navigator/22-static-image-errors.json">Layer - Static Image - errors</option>
          <option value="./configs/navigator/23-csv.json">Layer - CSV -</option>
          <option value="./configs/navigator/32-shapefile.json">Layer - Shapefile -</option>
          <option value="./configs/navigator/24-vector-tile.json">Layer - Vector Tile -</option>
          <option value="./configs/navigator/25-geojson-multi.json">Layer - GeoJSON MutiPolygon -</option>
          <option value="./configs/navigator/28-geocore.json">Layer GeoView - GeoCore -</option>
          <option value="./configs/navigator/28-geocore-errors.json">Layer GeoView - GeoCore - errors</option>
          <option value="./configs/navigator/28-geocore-custom-inline-config.json">Layer GeoView - GeoCore Custom Inline Config -</option>
          <option value="./configs/navigator/27-geocore-custom.json">Layer GeoView - GeoCore Custom Config -</option>
          <option value="./configs/navigator/28-geocore-duplicates.json">Layer GeoView - Duplicate GeoCore Config -</option>
          <option value="./configs/navigator/29-geopackages.json">Layer GeoView - GeoPackages DEPRECATED-</option>
        </select>
      </div>
    </div>

    <div class="selector-container">
      <p>Display Language:</p>
      <div class="selector">
        <select name="Switch Language" id="switchLang">
          <option value="en">English</option>
          <option value="fr">French</option>
          <option value="unsupported">Not Supported</option>
        </select>
        <input type="checkbox" id="resetLayer" name="resetLayer" checked />
        <label for="resetLayer">Reset Layers</label>
      </div>
      <p>Display Theme:</p>
      <div class="selector">
        <select name="Switch Theme" id="switchTheme">
          <option value="geo.ca">Geo.ca</option>
          <option value="light">Light</option>
          <option value="dark">Dark</option>
          <option value="unsupported">Not Supported</option>
        </select>
      </div>
      <p>Display Projection:</p>
      <div class="selector">
        <select name="Switch Projection" id="switchProjection">
          <option value="3978">LCC (3978)</option>
          <option value="3857">Web Mercator (3857)</option>
          <option value="unsupported">Not Supported</option>
        </select>
      </div>
    </div>
    <hr />

    <button type="button" class="collapsible">Layers Status</button>
    <pre id="sandboxMap-state" class="panel map-title-holder"></pre>

    <div id="mapSection">
      <div id="map1"></div>
    </div>
    <p>This map loads it's configurations from a selected configuration file.</p>
    <hr />

    <div class="editor">
      <div class="line-numbers">
        <span></span>
      </div>
      <textarea id="configGeoview" name="configuration" rows="30" cols="150">
        Select a configuration file to see its content...
      </textarea>
    </div>

    <div class="actionButton">Reload Map <button id="Reload-Button">Reload</button></div>
    <div class="actionButton">Remove Map <button id="Remove-Button">Remove</button></div>
    <hr />

    <button type="button" class="collapsible">Code Snippet</button>
    <pre id="codeSnippet" class="panel"></pre>

    <script src="codedoc.js"></script>
    <script>
      const configLoader = document.getElementById('configLoader');
      const switchLang = document.getElementById('switchLang');
      const resetLayer = document.getElementById('resetLayer');
      const switchThemeElem = document.getElementById('switchTheme');
      const switchProjectioneElem = document.getElementById('switchProjection');
      const reload = document.getElementById('Reload-Button');
      const remove = document.getElementById('Remove-Button');
      const urlParams = new URLSearchParams(window.location.search);
      const config = urlParams.get('config');
      const mapId = 'map1';

      // ------------------ CONFIG SELECTOR SECTION START -----------------------------------------
      configLoader.addEventListener('change', async (e) => {
        // create new map in a new dom node
        let mapDiv = document.getElementById(mapId);
        if (mapDiv === null) {
          mapDiv = document.createElement('div');
          // const style = document.createAttribute('style'); // Commented this, because it wasn't doing anything
          mapDiv.setAttribute('id', mapId);
          document.getElementById('mapSection').appendChild(mapDiv);
        }

        // Set the language to the switchLang value, always
        mapDiv.setAttribute('data-lang', switchLang.value);

        // Delete previous map if existing
        if (cgpv.api.hasMapViewer(mapId)) {
          await cgpv.api.deleteMapViewer(mapId);
        }

        // create map
        try {
          const mapViewer = await cgpv.api.createMapFromConfig(mapId, e.target.value, 800);
          listenToLegendLayerSetChanges('sandboxMap-state', mapViewer);
        } catch (error) {
          console.error('Failed to create map from config', error);
        }

        try {
          // Fetch the data
          const res = await fetch(e.target.value);
          const data = await res.json();

          // fetch JSON config file to show in the text are section
          document.getElementById('configGeoview').textContent = JSON.stringify(data, null, 4);

          // set default number of lines
          const textarea = document.querySelector('textarea');
          const lineNumbers = document.querySelector('.line-numbers');
          const numberOfLines = textarea.value.split('\n').length;
          lineNumbers.innerHTML = Array(numberOfLines).fill('<span></span>').join('');

          // pre-select theme and projection from config file
          document.getElementById('switchTheme').value = data.theme;
          document.getElementById('switchProjection').value = data.map.viewSettings.projection;

          // update url to include selected file
          const element = document.getElementById('configLoader');
          window.history.replaceState(null, null, `?config=${element.value}`);
        } catch (error) {
          console.error('Unable to fetch data:', error)
        }
      });
      // ------------------ CONFIG SELECTOR SECTION END -----------------------------------------

      // If there's a config
      if (config) {
        configLoader.value = config;
        configLoader.dispatchEvent(new Event('change'));
      }

      // ------------------ SWITCHER SECTION START -----------------------------------------
      switchLang.addEventListener('change', (e) => {
        cgpv.api.getMapViewer(mapId).setLanguage(e.target.value, resetLayer.checked);
      });

      switchThemeElem.addEventListener('change', (e) => {
        cgpv.api.getMapViewer(mapId).setTheme(e.target.value);
      });

      switchProjectioneElem.addEventListener('change', (e) => {
        cgpv.api.getMapViewer(mapId).setProjection(e.target.value);
      });
      // ------------------ SWITCHER SECTION END -----------------------------------------

      reload.addEventListener('click', (e) => {
        cgpv.api.reload(mapId);
      });

      remove.addEventListener('click', (e) => {
        cgpv.api.deleteMapViewer(mapId, true);
      });

      // create snippets
      window.addEventListener('load', () => {
        createCodeSnippet();
        createConfigSnippet();
      });
    </script>
  </body>
</html>

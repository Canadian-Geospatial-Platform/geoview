<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Sandbox - Canadian Geospatial Platform Viewer</title>
    <link rel="shortcut icon" href="./favicon.ico" />
    <meta name="msapplication-TileColor" content="#da532c" />
    <meta name="msapplication-config" content="./img/browserconfig.xml" />
    <meta name="theme-color" content="#ffffff" />
    <link rel="stylesheet" href="css/style.css" />
  </head>

  <body>
    <div>
      <div id="page-header"></div>

      <div class="back-to-main">
        <a href="../index.html?tab=sandbox">‚Üê Back to Main</a>
      </div>

      <div class="demo-section">
        <h4>Interactive Sandbox</h4>
        <p>
          Experiment with GeoView in a live sandbox environment. Test configurations, explore features, and prototype your solutions. Edit
          the JSON configuration below and click "Reload" to see your changes.
        </p>
      </div>
    </div>
    <div class="editor">
      <div class="line-numbers">
        <span></span>
      </div>
      <textarea id="configGeoview" name="configuration" rows="30" cols="150">
{
  'map': {
    'interaction': 'dynamic',
    'viewSettings': {
      'projection': 3978
    },
    'basemapOptions': {
      'basemapId': 'transport',
      'shaded': false,
      'labeled': true
    },
    'listOfGeoviewLayerConfig': [{
      'geoviewLayerId':'airborne_radioactivity',
      'geoviewLayerName':'Airborne Radioactivity',
      'metadataAccessPath':'https://maps-cartes.services.geo.ca/server_serveur/rest/services/HC/airborne_radioactivity_en/MapServer',
      'geoviewLayerType':'esriDynamic',
      'listOfLayerEntryConfig': [
        {
            'layerId':'0'
        }
      ]
  }]
  },
  'components': ['overview-map', 'north-arrow'],
  'footerBar': {
    'tabs': {
      'core': ['layers', 'data-table', 'geochart']
    }
  },
  'appBar': {
    'tabs': {
      'core': ['legend', 'details', 'geolocator', 'export']
    }
  },
  'corePackages': [],
  'corePackagesConfig':[
    {
      'geochart': { 'charts': [
        {
          'layers':[{
            'layerId':'airborne_radioactivity/0/1',
            'propertyValue': 'OBJECTID',
            'propertyDisplay': 'Location_Emplacement'
          }],
          'chart': 'line',
          'query': {
            'type': 'esriRegular',
            'url': 'https://maps-cartes.services.geo.ca/server_serveur/rest/services/HC/airborne_radioactivity_en/MapServer/3',
            'queryOptions': {
              'whereClauses': [
                {
                  'field': 'Location_Emplacement',
                  'prefix': '\u0027',
                  'valueFrom': 'Location_Emplacement',
                  'suffix': '\u0027'
                }
              ],
              'orderByField': 'CollectionStart_DebutPrelevement'
            }
          },
          'geochart': {
            'xAxis': {
              'type': 'time',
              'property': 'CollectionStart_DebutPrelevement',
              'label': 'Collected date'
            },
            'yAxis': {
              'type': 'linear',
              'property': 'Activity_Activite_mBqm3',
              'label': 'Activity (mBqm3)',
              'tooltipSuffix': 'mBqm3'
            },
            'borderWidth': 1
          },
          'category': {
            'property': 'Radionuclide_Radionucleide',
            'usePalette': false
          },
          'ui': {
            'xSlider': {
              'display': true
            },
            'ySlider': {
              'display': true
            },
            'stepsSwitcher': true,
            'description': 'This is a description text',
            'download': true
          }
        }
      ]}
    }
  ],
  'theme': 'geo.ca'
}
      </textarea>
    </div>

    <div class="navigator-toolbar">
      <button id="validateConfig" class="btn btn-success btn-large">Validate</button>
      <button id="createMap" class="btn btn-primary btn-large">Create Map</button>
      <button id="deleteMap" class="btn btn-danger btn-large">Delete Map</button>
      <span id="validationMessage" class="sandbox-validation-msg">File not validated...</span>
    </div>

    <div class="demo-section">
      <h4>Custom Map Size</h4>
      <div class="selector-container navigator-selector-wrap">
        <div class="navigator-option-group">
          <label for="mapWidth" class="navigator-label">Width:</label>
          <input type="text" placeholder="Width (px)" id="mapWidth" class="sandbox-input-short" />
        </div>
        <div class="navigator-option-group">
          <label for="mapHeight" class="navigator-label">Height:</label>
          <input type="text" placeholder="Height (px)" id="mapHeight" class="sandbox-input-short" />
        </div>
        <button type="button" id="applyMapSize" disabled class="btn btn-primary">Apply Size</button>
      </div>
    </div>

    <div class="demo-section">
      <h4 id="HLCONF1">Sandbox Map</h4>
    </div>
    <button type="button" class="collapsible">Layers Status</button>
    <pre id="sandboxMap-state" class="panel map-title-holder"></pre>

    <div id="mapSection" class="navigator-map-section">
      <div id="map1"></div>
    </div>

    <div class="demo-section">
      <p><em>This map loads its configuration from the text area above.</em></p>
    </div>

    <script src="codedoc.js"></script>
    <script>
      insertPageHeader();

      const isValid = false;

      // Validate Button============================================================================================================
      const validateJSONButton = document.getElementById('validateConfig');

      // add an event listener when a button is clicked
      validateJSONButton.addEventListener('click', function (e) {
        // get message element
        const message = document.getElementById('validationMessage');

        try {
          // get config and test if JSON is valid
          const configArea = document.getElementById('configGeoview');
          const regexExp = /(?<!\\)'/g;
          // Replace single quotes with double quotes
          const configJSON = JSON.parse(configArea.value.replace(regexExp, '"'));

          const validConfig = cgpv.api.config.validateMapConfig(configJSON, 'en');

          // set class and message
          message.classList.add('config-json-valid');
          message.classList.remove('config-error');
          message.innerHTML = 'File seems valid, see console for details...';
          document.getElementById('createMap').disabled = 0;
        } catch (error) {
          // set class and message
          message.classList.add('config-error');
          message.classList.remove('config-json-valid');
          message.innerHTML = cgpv.api.utilities.core.escapeRegExp(error.message);
          document.getElementById('createMap').disabled = true;
        }
      });

      // Create Button============================================================================================================
      const createMapButton = document.getElementById('createMap');

      // add an event listener when a button is clicked
      createMapButton.addEventListener('click', async function (e) {
        // Delete previous map if existing
        if (cgpv.api.hasMapViewer('map1')) {
          await cgpv.api.deleteMapViewer('map1', true);
        }

        // create new map in a new dom node
        const newDiv = document.createElement('div');
        const a = document.createAttribute('id');
        a.value = 'map1';
        newDiv.setAttributeNode(a);

        const mapWidth = `${document.getElementById('mapWidth')?.value}px`;
        const mapHeight = `${document.getElementById('mapHeight')?.value}px`;

        newDiv.style.width = mapWidth;
        newDiv.style.minHeight = mapHeight;

        newDiv.dataset.height = mapHeight;

        document.getElementById('mapSection').appendChild(newDiv);

        // Regex expression to capture all single quotes (') except those preceded by a backslash (\)
        const regexExp = /(?<!\\)'/g;

        // create map
        try {
          const configArea = document.getElementById('configGeoview');
          // Replace single quotes with double quotes to make valid JSON
          const mapViewer = await cgpv.api.createMapFromConfig('map1', configArea.value.replace(regexExp, '"'));
          listenToLegendLayerSetChanges('sandboxMap-state', mapViewer);
        } catch (error) {
          console.error('Failed to create map from config', error);
        }
      });

      // Map Size=====================Start==================================
      const applyMapSizeBtn = document.getElementById('applyMapSize');
      const mapWidthInput = document.getElementById('mapWidth');
      const mapHeightInput = document.getElementById('mapHeight');

      applyMapSizeBtn.addEventListener('click', () => {
        const mapWidth = document.getElementById('mapWidth')?.value;
        const mapHeight = document.getElementById('mapHeight')?.value;

        /**
         * ===========================================================================
         *  MIN WIDTH and MIN HEIGHT should be greater than 0
         * ===========================================================================
         */
        if (parseInt(mapWidth) > 0 && parseInt(mapHeight) > 0) {
          createMapButton.dispatchEvent(new Event('click'));
        }
      });

      mapWidthInput.addEventListener('input', () => {
        applyMapSizeBtn.removeAttribute('disabled');
      });

      mapHeightInput.addEventListener('input', () => {
        applyMapSizeBtn.removeAttribute('disabled');
      });

      const widthInput = document.getElementById('mapWidth');
      const heightInput = document.getElementById('mapHeight');

      // Set the map width input value based on map section width.
      if (widthInput) {
        const mapSection = document.getElementById('mapSection');
        widthInput.value = mapSection.clientWidth;
      }

      document.getElementById('mapHeight').value = '900';

      const sandboxMap = document.getElementById('map1');
      if (sandboxMap) {
        sandboxMap.dataset.height = '900px';
      }

      // Map Size=====================End==================================

      const deleteMapButton = document.getElementById('deleteMap');

      // add an event listener when a button is clicked
      deleteMapButton.addEventListener('click', function (e) {
        // Delete the map
        cgpv.api.deleteMapViewer('map1', true);
      });

      // Editor script section===================================================================================================
      const textarea = document.querySelector('textarea');
      const lineNumbers = document.querySelector('.line-numbers');

      // set default number of lines
      const numberOfLines = textarea.value.split('\n').length;
      lineNumbers.innerHTML = Array(numberOfLines).fill('<span></span>').join('');

      textarea.addEventListener('keyup', (event) => {
        const numberOfLines = event.target.value.split('\n').length;
        lineNumbers.innerHTML = Array(numberOfLines).fill('<span></span>').join('');
      });

      textarea.addEventListener('input', (event) => {
        document.getElementById('createMap').disabled = true;
      });
    </script>
  </body>
</html>

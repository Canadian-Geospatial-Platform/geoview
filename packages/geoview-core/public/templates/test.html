<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title><%= htmlWebpackPlugin.options.title %></title>
    <link rel="shortcut icon" href="./favicon.ico" />
    <meta name="msapplication-TileColor" content="#da532c" />
    <meta name="msapplication-config" content="./img/browserconfig.xml" />
    <meta name="theme-color" content="#ffffff" />
    <meta name="msapplication-TileColor" content="#da532c" />
    <meta name="theme-color" content="#ffffff" />
    <link href="https://fonts.googleapis.com/css?family=Roboto|Montserrat:200,300,400,900|Merriweather" rel="stylesheet" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons" />
    <link rel="stylesheet" href="css/style.css" />
  </head>
  <body>
    <button class="Test-Visibility">Test Visibility</button>
    <div id="LYR1" class="llwp-map" data-lang="en" data-config="{
      'map': {
        'interaction': 'dynamic',
        'viewSettings': {
          'zoom': 4,
          'center': [-100, 60],
          'projection': 3978
        },
        'basemapOptions': {
          'basemapId': 'transport',
          'shaded': false,
          'labeled': false
        },
        'listOfGeoviewLayerConfig': [
          {
            'geoviewLayerId': 'esriDynamicLYR3z',
            'geoviewLayerName': { 'en': 'Energy (Esri-dynamic)' },
            'metadataAccessPath': { 'en': 'https://maps-cartes.ec.gc.ca/arcgis/rest/services/CESI/MapServer' },
            'geoviewLayerType': 'esriDynamic',
            'listOfLayerEntryConfig': [
              {
                'layerId': '8'
              }
            ]
          },
          {
            'geoviewLayerId': 'esriDynamicLYR3z',
            'geoviewLayerName': { 'en': 'Energy (Esri-dynamic)' },
            'metadataAccessPath': { 'en': 'https://maps-cartes.ec.gc.ca/arcgis/rest/services/CESI/MapServer' },
            'geoviewLayerType': 'esriDynamic',
            'listOfLayerEntryConfig': [
              {
                'layerId': '8'
              }
            ]
          }
        ]
      },
      'components': ['overview-map', 'nav-bar'],
      'corePackages': [],
      'theme': 'dark',
      'suportedLanguages': ['en']
    }">
    </div>
    <button class="Get-Legend">Get Legend</button>
    <div id="legend-table-div"></div>
    <button type="button" class="collapsible">Get Feature Info</button>
    <pre style="height: 20pc; overflow-y: scroll;"  id="wmsResultSetId" class="panel">Click on feature on the map</pre>
    <hr />
    <button type="button" class="collapsible">Configuration Snippet</button>
    <pre id="LYR1CS" class="panel"></pre>
    <hr />
    <script src="codedoc.js"></script>
    <script>
      // initialize cgpv and api events, a callback is optional, used if calling api's after the rendering is ready
      cgpv.init(function () {
        console.log('api is ready');
        //create snippets
        createCodeSnippet();
        createConfigSnippet();
      });
    // WMS ======================================================================================================================
    const featureInfoWmsLayerSet = cgpv.api.createFeatureInfoLayerSet('LYR1', 'wmsResultSetId');
    cgpv.api.event.on(cgpv.api.eventNames.GET_FEATURE_INFO.ALL_QUERIES_DONE, (payload) => {
      const {  layerSetId, resultSets } = payload;
      document.getElementById(layerSetId).textContent = JSON.stringify(resultSets, undefined, 2);
    }, 'LYR1');

    const LegendsWmsLayerSet = cgpv.api.createLegendsLayerSet('LYR1', 'wmsLegendsId');
    cgpv.api.event.on(cgpv.api.eventNames.GET_LEGENDS.ALL_LEGENDS_DONE, (payload) => {
      const {  layerSetId, resultSets } = payload;
      displayLegend(layerSetId, resultSets);
    }, 'LYR1');

    var addGeoJsonLegendButton = document.getElementsByClassName('Get-Legend')[0];
    addGeoJsonLegendButton.addEventListener('click', function (e) {
      cgpv.api.event.emit({ handlerName: 'LYR1', event: cgpv.api.eventNames.GET_LEGENDS.TRIGGER, layerSetId: 'wmsLegendsId' });
    });

    // ==========================================================================================================================
    function displayLegend(layerSetId, resultSets) {
      const addHeader = (title, container) => {
        const tableHeader = document.createElement('th');
        tableHeader.style = "text-align: center; vertical-align: middle;"
        tableHeader.innerHTML =  title;
        container.appendChild(tableHeader);
      }
      const addData = (data, container) => {
        const tableData = document.createElement('td');
        tableData.style.verticalAlign = 'middle';
        tableData.style.textAlign = 'center';
        if (typeof data === 'string') tableData.innerHTML =  data.replaceAll('<', '&lt;').replaceAll('>', '&gt;');
        else tableData.appendChild(data);
        container.appendChild(tableData);
      }
      var oldTable = document.getElementById(`${layerSetId}-table`);
      if (oldTable) oldTable.parentNode.removeChild(oldTable)
      var legendTable = document.getElementById('legend-table-div');
      const table = document.createElement('table');
      table.id = `${layerSetId}-table`;
      table.border="1";
      table.style="width:50%";
      legendTable.appendChild(table);
      var createHeader = true;
      Object.keys(resultSets).forEach((layerPath) => {
        if (resultSets[layerPath]?.type === 'ogcWms') {
          if (createHeader) {
            createHeader = false;
            const tableRow1 = document.createElement('tr');
            table.appendChild(tableRow1);
            addHeader("Layer Path", tableRow1);
            addHeader("Symbology", tableRow1);
          }
          const tableRow = document.createElement('tr');
          addData(resultSets[layerPath].layerPath, tableRow);
          addData(resultSets[layerPath].legend, tableRow);
          table.appendChild(tableRow);
        } else {
          const addRow = (layerPath, label, canvas) => {
            const tableRow = document.createElement('tr');
            addData(layerPath, tableRow);
            addData(label, tableRow); // canvas.style = "border: 1px solid black;"
            addData(canvas, tableRow);
            table.appendChild(tableRow);
          }
          if (createHeader) {
            createHeader = false;
            const tableRow1 = document.createElement('tr');
            table.appendChild(tableRow1);
            addHeader("Layer Path", tableRow1);
            addHeader("Label", tableRow1);
            addHeader("Symbology", tableRow1);
          }
          if (resultSets[layerPath]?.legend) {
            Object.keys(resultSets[layerPath].legend).forEach((geometryKey) => {
              if (geometryKey) {
                if (resultSets[layerPath].styleConfig[geometryKey].styleType === "uniqueValue") {
                  if (resultSets[layerPath].legend[geometryKey].defaultCanvas)
                    addRow(layerPath,
                            resultSets[layerPath].styleConfig[geometryKey].defaultLabel,
                            resultSets[layerPath].legend[geometryKey].defaultCanvas);
                  for (let i = 0; i < resultSets[layerPath].legend[geometryKey].arrayOfCanvas.length; i++) {
                    addRow(layerPath,
                          resultSets[layerPath].styleConfig[geometryKey].uniqueValueStyleInfo[i].label,
                          resultSets[layerPath].legend[geometryKey].arrayOfCanvas[i]);
                  }
                } else if (resultSets[layerPath].styleConfig[geometryKey].styleType === "classBreaks") {
                  if (resultSets[layerPath].legend[geometryKey].defaultCanvas)
                    addRow(layerPath,
                            resultSets[layerPath].styleConfig[geometryKey].defaultLabel,
                            resultSets[layerPath].legend[geometryKey].defaultCanvas);
                  for (let i = 0; i < resultSets[layerPath].legend[geometryKey].arrayOfCanvas.length; i++) {
                    addRow(layerPath,
                          resultSets[layerPath].styleConfig[geometryKey].classBreakStyleInfos[i].label,
                          resultSets[layerPath].legend[geometryKey].arrayOfCanvas[i]);
                  }
                } else if (resultSets[layerPath].styleConfig[geometryKey].styleType === "simple") {
                  addRow(layerPath,
                        resultSets[layerPath].styleConfig[geometryKey].label,
                        resultSets[layerPath].legend[geometryKey].defaultCanvas);
                }
              }
            });
          }
        }
      });
    }

    const cycleThroughtLayers = (delay) => {
      setTimeout(() => {
        cgpv.api.maps.LYR1.layer.geoviewLayers.esriDynamicLYR3z.setVisible(delay, 'esriDynamicLYR3z/8/9');
        cgpv.api.maps.LYR1.layer.geoviewLayers.esriDynamicLYR3z.setVisible(false, 'esriDynamicLYR3z/8/20');
        setTimeout(() => {
          cgpv.api.maps.LYR1.layer.geoviewLayers.esriDynamicLYR3z.setVisible(delay, 'esriDynamicLYR3z/8/10');
          cgpv.api.maps.LYR1.layer.geoviewLayers.esriDynamicLYR3z.setVisible(false, 'esriDynamicLYR3z/8/9');
          setTimeout(() => {
            cgpv.api.maps.LYR1.layer.geoviewLayers.esriDynamicLYR3z.setVisible(delay, 'esriDynamicLYR3z/8/11');
            cgpv.api.maps.LYR1.layer.geoviewLayers.esriDynamicLYR3z.setVisible(false, 'esriDynamicLYR3z/8/10');
            setTimeout(() => {
              cgpv.api.maps.LYR1.layer.geoviewLayers.esriDynamicLYR3z.setVisible(delay, 'esriDynamicLYR3z/8/12');
              cgpv.api.maps.LYR1.layer.geoviewLayers.esriDynamicLYR3z.setVisible(false, 'esriDynamicLYR3z/8/11');
              setTimeout(() => {
                cgpv.api.maps.LYR1.layer.geoviewLayers.esriDynamicLYR3z.setVisible(delay, 'esriDynamicLYR3z/8/13');
                cgpv.api.maps.LYR1.layer.geoviewLayers.esriDynamicLYR3z.setVisible(false, 'esriDynamicLYR3z/8/12');
                setTimeout(() => {
                  cgpv.api.maps.LYR1.layer.geoviewLayers.esriDynamicLYR3z.setVisible(delay, 'esriDynamicLYR3z/8/14');
                  cgpv.api.maps.LYR1.layer.geoviewLayers.esriDynamicLYR3z.setVisible(false, 'esriDynamicLYR3z/8/13');
                  setTimeout(() => {
                    cgpv.api.maps.LYR1.layer.geoviewLayers.esriDynamicLYR3z.setVisible(delay, 'esriDynamicLYR3z/8/15');
                    cgpv.api.maps.LYR1.layer.geoviewLayers.esriDynamicLYR3z.setVisible(false, 'esriDynamicLYR3z/8/14');
                    setTimeout(() => {
                      cgpv.api.maps.LYR1.layer.geoviewLayers.esriDynamicLYR3z.setVisible(delay, 'esriDynamicLYR3z/8/16');
                      cgpv.api.maps.LYR1.layer.geoviewLayers.esriDynamicLYR3z.setVisible(false, 'esriDynamicLYR3z/8/15');
                      setTimeout(() => {
                        cgpv.api.maps.LYR1.layer.geoviewLayers.esriDynamicLYR3z.setVisible(delay, 'esriDynamicLYR3z/8/17');
                        cgpv.api.maps.LYR1.layer.geoviewLayers.esriDynamicLYR3z.setVisible(false, 'esriDynamicLYR3z/8/16');
                        setTimeout(() => {
                          cgpv.api.maps.LYR1.layer.geoviewLayers.esriDynamicLYR3z.setVisible(delay, 'esriDynamicLYR3z/8/18');
                          cgpv.api.maps.LYR1.layer.geoviewLayers.esriDynamicLYR3z.setVisible(false, 'esriDynamicLYR3z/8/17');
                          setTimeout(() => {
                            cgpv.api.maps.LYR1.layer.geoviewLayers.esriDynamicLYR3z.setVisible(delay, 'esriDynamicLYR3z/8/19');
                            cgpv.api.maps.LYR1.layer.geoviewLayers.esriDynamicLYR3z.setVisible(false, 'esriDynamicLYR3z/8/18');
                            setTimeout(() => {
                              cgpv.api.maps.LYR1.layer.geoviewLayers.esriDynamicLYR3z.setVisible(delay, 'esriDynamicLYR3z/8/20');
                              cgpv.api.maps.LYR1.layer.geoviewLayers.esriDynamicLYR3z.setVisible(false, 'esriDynamicLYR3z/8/19');
                            }, delay);
                          }, delay);
                        }, delay);
                      }, delay);
                    }, delay);
                  }, delay);
                }, delay);
              }, delay);
            }, delay);
          }, delay);
        }, delay);
      }, delay);
    }

    var testVisibility = document.getElementsByClassName('Test-Visibility')[0];
    testVisibility.addEventListener('click', function (e) {
      cycleThroughtLayers(0);
      cycleThroughtLayers(2000);
    });
    </script>
  </body>
</html>
